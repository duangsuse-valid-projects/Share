---
title: ç»å¥ç¨‹åºè®¾è®¡è¯­è¨€
author: duangsuse
date: Dec 31, 2019
category: Lang
tags: Tech CS PLT Kotlin Literate
keywords: Java Haskell
---

# ç»å¥ç¨‹åºè®¾è®¡è¯­è¨€ã€è¯æ³•å®šä¹‰ã€

> ğŸ˜ä¸­æ–‡ç¼–ç¨‹ä¹ŸçœŸæ˜¯å¯æ€œã€‚æ‡‚çš„äººå¯¹å®ƒå—¤ä¹‹ä»¥é¼»ï¼Œä¸€æåˆ°ç«‹åˆ»è¯´å®ƒæ˜¯ _è‚¤æµ…ã€è¡¨é¢_ çš„ï¼Œååæ˜¯å®Œå…¨ä¸æ‡‚å’ŒåŠæ‡‚ä¸æ‡‚çš„äººç¨å¾®æœ‰ç‚¹æˆ–ç©ºæ— ä¸€ç‰©æˆ–åŠé€šä¸é€šçš„ã€å®è·µç»éªŒã€
ä¸çŸ¥é“æ˜¯ä¸æ˜¯å’Œä¹‹å‰çš„ã€æ±‰èŠ¯ã€ä¸€æ ·ï¼Œå› ä¸ºæ˜“è¯­è¨€çš„4kwåäº†åå£°ï¼Ÿå‘µå‘µå‘µâ€¦â€¦ä½†ä¸ç®¡æ€ä¹ˆæ ·æ˜“è¯­è¨€çš„ç¡®æ˜¯å¹¿ä¸ºè¯Ÿç—…äº†ã€‚

_ç»å¥è¨€è€…ï¼Œç¼–ç¨‹ä¹‹ç¾ã€‚_

ç»å¥æ˜¯ä¸€é—¨é¢å‘å¯¹è±¡+å‡½æ•°å¼ç¨‹åºè®¾è®¡è¯­è¨€ï¼Œå®ƒåŸºæœ¬æ˜¯æ‰©å±•è‡ªKotlinï¼Œæœ‰ç±»å‹æ¨å¯¼ã€ç±»å‹å¯ç©ºæ€§ã€é—­åŒ…(closure) å’Œé«˜é˜¶å‡½æ•°ã€æ‰©å±•å‡½æ•°å’Œå±æ€§ã€ç”Ÿäº§æ¶ˆè´¹è€…å‹å˜æ€§æ ‡è®°ã€å€¼ä»£ç†ã€é¢å‘å¯¹è±¡æ··å…¥(mixins) ç­‰ç‰¹æ€§ï¼Œæ­¤æ–‡æ¡£çš„æè¿°ç›®æ ‡æ˜¯ç‰ˆæœ¬0.1ã€‚

+ `ã€æŸã€` ä¸ºå¯ä¸å¸¦ç©ºæ ¼çš„ã€è§’æ‹¬åå­—ã€ã€`ã€ŒæŸã€` ä¸ºä¸­ç¼€è¡¨ç¤ºã€`ã€æŸæ–‡å½¢ã€‘` ä¸ºæ ‡è®°ä¿®é¥°ã€`ã€–æŸæ–‡å½¢ã€—` ä¸ºå—å‚æ•°åˆ—è¡¨
+ `[]` ä¸ºä¸‹æ ‡è®¿é—®(get/set) å’Œè·³è½¬ã€å¸¸è¨€ç”¨åŸŸæ ‡ç­¾
+ `<æŸæ–‡å½¢>` æ³›å‹å‚æ•° `(è¨€ç»„)` è°ƒç”¨å‚æ•°å’Œè¨€ç»„ä»¥åŠè¡¨ç¤ºå‡½æ•°ç±»å‹ã€`ï¼ˆï¼‰` ä¸å¯ç”¨
+ `çš„`ã€`å»` ä¸ºè®¿é—®ä¸­é—´ç¬¦ã€`::` å‡½æ•°å¼å¼•ç”¨æ¶æ„å™¨ã€ã€Œå±ã€ä¸­æ–¹æ³•å’Œã€Œä¹¦ã€çº§å‡½æ•°ã€`å»::` å¼•ç”¨å®ä¾‹æ–¹æ³•
+ `"s"` å­—ç¬¦ä¸²ã€`"""s"""` è·¨è¡Œå­—ç¬¦ä¸²ã€`'c'` å­—ç¬¦ï¼Œ`\t\b\n\r\"\'\$\\`ã€`\uXXXX`ã€`$a`ã€`${e}` String Interpolation ä¸ Kotlin ä¸€è‡´
+ ã€Œ`ï¼Œ`ã€ã€Œ`ã€‚`ã€é€—å·è¡¨ç¤ºæ³•ç”¨ï¼Œã€Œ`ã€`ã€é€—å·è¡¨ç¤ºæ³•å’Œåˆ‡åˆ†å…¼ç”¨ã€`,` ä¸å¯ç”¨
+ `ï¼›` åˆ‡åˆ†ã€Œå¥ã€ï¼Œæ¢è¡Œä¹Ÿå¯ï¼Œã€Œ`;`ã€ä¸å¯ç”¨
+ `ï¼š` å±(type)å®šä¹‰ï¼Œã€Œ`:`ã€ä¸å¯ç”¨
+ `...` å¼ã€å˜é•¿å‚æ•°ã€å·²ç»è¢«ã€Œè®¸å¤šã€å‚æ•°ä¿®é¥°ç¬¦ä»£æ›¿ï¼Œä¸å¯ç”¨
+ `_` ä¸ºè¯­è¨€å¸¸æ„è¯ï¼Œæ‰€æœ‰ __ä»…ä»¥__ `_` æ„æˆçš„åå­—çš†ä¸å¯ç”¨
+ `ã€ˆã€‰`ã€`ï¼»ï¼½`ã€`ã€Šã€‹`ã€`ã€”ã€•`ã€`{}`ã€`=>`ã€`#` ä¿ç•™ä½œæœªæ¥ä½¿ç”¨
+ æ–‡ä»¶å¼€å¤´çš„ `#!` è¡Œæ˜¯è¢«å¿½ç•¥çš„
+ `â€œæŸâ€` __å¯åµŒå¥—__ æ³¨é‡Š `â€˜æŸâ€™` __å¯åµŒå¥—__ æ–‡æ¡£
+ ç»å¥é‡Œ `[' ' '\t' '\f']` æ˜¯ç©ºæ ¼ã€`['\n' '\r']` æ˜¯æ¢è¡Œ
+ åå­—é‡Œå¯é€‰çš„å­—ç¬¦ä¸Kotlinç±»ä¼¼(Unicodeå­—ç¬¦ç±»)ï¼šLï¼ˆMã€Oã€Tã€Uï¼‰ï¼›NL
+ ã€Œ`.`ã€ä¸ºã€å¤å(å¤åˆåå­—, qualified-id)ã€çš„ä¸€éƒ¨åˆ†

æ„è¯åˆ†ã€è½¯ã€å¸¸ã€è‹›ã€ä¸‰ç§ã€‚
å…¶ä¸­ï¼Œè½¯æ„è¯å¯ä»¥ä½œä¸ºåå­—ã€å¸¸æ„è¯ä¸èƒ½ä½œä¸ºéè§’æ‹¬åå­—ï¼Œ__è‹›æ„è¯ä¸èƒ½ä½œä¸ºéè§’æ‹¬åå­—çš„èµ·å§‹éƒ¨åˆ†__

ç»å¥æ–‡æ³•å±‚æ¬¡ï¼šå¸¸é‡(literal)ã€è¨€(expression)ã€å¥(statement)ã€æ®µ(block)ï¼Œ
ä½“(body)ã€æ„(structure)ã€ä¹¦(file)

ç»å¥é¢å‘å¯¹è±¡ç»“æ„å±‚æ¬¡ï¼šç±»(`interface`)ã€ç‰©(`class`) é€ äº(`constructor`) åˆ(`init`)ã€ä¾‹(`object`)ã€äº‹(`fun`)ã€é‡(`val`) å–è€…(getter)ã€ç½®è€…(setter)ã€å˜å‚(`var`)

+ ã€Œå±åˆ«å(`typealias`)ã€å¯åœ¨ã€Œä¹¦ã€å±‚æ¬¡å®šä¹‰
+ ã€Œäº‹ã€ä¹Ÿå¯åœ¨ã€Œä¹¦ã€å±‚æ¬¡å®šä¹‰
+ ã€Œå¸¸å‚(`const val`)ã€å¯åœ¨ã€Œä¹¦ã€æˆ–ã€Œä¾‹ã€å±‚æ¬¡å®šä¹‰
+ ã€Œå˜å‚(`var`)ã€çš„åˆè¨€(initializer) ç”¨ã€Œ`åˆ`ã€è€Œé `=` å·è¿æ¥

å…³äºå‡½æ•°å¼çš„ `::` è¯­æ³•ï¼š

```kotlin
fun <T> fx(f: (T, T) -> T, x: T): T = f(x, x)
fx(Int::plus, 1)
```

å¯¹ `::` æ¥è¯´ `æŸæˆ‘.(å‚1ã€å‚2ã€ä½™)è¿”` ä¹Ÿå¯è§†ä¸º `(æŸæˆ‘ã€å‚1ã€å‚2ã€ä½™)è¿”` å®ç°ã€‚

å…³äºã€ŒåŒ…ã€å‘½åç©ºé—´åŒ–å®šä¹‰å¼•ç”¨ï¼š

ä¸€ä¸ªæ–‡ä»¶åªå¯å®šä¹‰ä¸€ä¸ªåŒ…ã€`åŒ…(å:å¤å)ä¸º` ä¸å¼ºæ±‚åœ¨ç‰¹å®šè·¯å¾„çš„æ–‡ä»¶ä¸­å®šä¹‰ï¼Œåªè¦å¤ååŒ¹é…å³å¯å¼•ç”¨ï¼ˆä½†ç¼–è¯‘å™¨å™¨åº”è¯¥å‘Šè­¦ï¼‰ã€‚

```plain
åŒ… æŸå¹´.æŸæœˆ.æŸæ—¥ ä¸º â€œåº”è¯¥åœ¨ æŸæ—¥/ æ–‡ä»¶å¤¹ä¸­ï¼Œè€Œå…¶çˆ¶æ–‡ä»¶å¤¹æ˜¯ æŸæœˆ/ï¼Œåˆçˆ¶æ–‡ä»¶å¤¹æ˜¯ æŸå¹´/â€
å¼• ä¸Šæœˆçš„äº‹æƒ… â€œä½¿ç”¨è¿™ç§ç®€å†™æ³•æ¥å¼•ç”¨ æŸå¹´.æŸæœˆ åŒ…ä¸­çš„æ„ä»¶â€
```

è‹¥ `å¼•`ã€`å¼•å…¨`ã€`å¼•è®°æ³•` çš„ç›®æ ‡åéƒ¨åˆ†æ²¡æœ‰ç”¨ã€Œå¤åã€ï¼Œåˆ™è¡¨ç¤ºå¼•å…¥æ­¤åŒ…ä¸Šä¸€é˜¶ï¼ˆå¤åçš„æœ€åä¸€ä¸ªã€Œ`.`ã€å‰ï¼‰åŒ…é‡Œåä¸ºå½¼çš„äº‹ç‰©ï¼Œä½¿ç”¨ `å¼•(å¤å‘½)çš„(å)`ã€`å¼•å…¨(å¤å)çš„(å)` ç±»ä¼¼ Java 1.5 çš„ `import static`ã€‚

ç»å¥ä¸ºæ‰€æœ‰æ–‡ä»¶é»˜è®¤ `å¼•å…¨ ç»å¥.é¢è”`ã€`ç»å¥.åŒºé—´`ã€`ç»å¥.é›†åˆ`ã€`ç»å¥.è¯»å†™`ã€`ç»å¥.æ–‡æœ¬`ã€`ç»å¥.æ ‡è®°`ã€‚

## æ„è¯(keywords)

> æ™®é€šæ„è¯ä¸€èˆ¬ä¸º __å¸¸æ„è¯__

+ åŒ… _ä¸º_
+ ä¸º å…¶ä¸­ _è½¯ï¼ŒHaskellå¼whereã€å¯¹ä½•çš†æœ‰ å…¼ç”¨_
+ å¼• å¼•å…¨
+ æˆ _è‹›ï¼Œåˆ¤(è¨€) å…¼ç”¨_  é™¤   äº _åˆ¤.å±/å­˜ (è¨€)ç”¨_
+ å®šè®°æ³• å¼•è®°æ³•
+ å±åˆ«å
+ å¸¸å‚ _è‹›_
+ ç±» ç‰© ä¾‹
+ ä¼´ç”Ÿä¾‹
+ å‚¨ç‰© _(data)_ ä¾‹ç‰© _(enum)_ å†µç‰© _(sealed)_ æŠ½è±¡ç‰© _(abstract)_
+ æ‰©ç‰© _ç»å¥ä½¿ç”¨æ›´è§„èŒƒçš„äº‹/é‡æ‰©å±•æ–¹å¼_ å†…ç‰© _(inner)_
+ è®°ç‰© _(annotation)_ å†…è”ç‰© _(inline)_
+ å¯¹ä½• çš†æœ‰ _è½¯_
+ é€ äº _constructor_ åˆ _è‹›ï¼Œå˜å‚åˆå§‹åŒ–å…¼ç”¨_
+ äº‹ _è‹›_ é‡ _è‹›_
+ å–è€… ç½®è€… ä»£è€… _by_
+ è§£é‡ _è‹›_ å˜å‚ _è‹›ï¼Œvar_
+ ä½  _è‹›ï¼Œç¬¬äºŒäººç§°æ–‡æ³•æ„è¯_
+ `é@` _è‹›_
+ `-@` _ã€å–è´Ÿã€_ `+@` _ã€å–æ­£ã€_
+ `@!` _éç©ºå€¼æ–­è¨€_
+ ~~typeof~~

ã€Œä½ ã€æ˜¯ç»å¥çš„ç¬¬äºŒäººç§°æ–‡æ³•ï¼Œé™¤äº†å¤–è¿˜æœ‰ç¬¬ä¸€äººç§°çš„ã€Œæˆ‘ã€ã€Œäº²ã€ã€ç¬¬ä¸‰äººç§°ã€Œå®ƒã€ã€‚

ç›´æ¥ç”¨æ³•æœ‰ä¸¤ç§ï¼š`ä½ (è¨€)â€¦â€¦` ä½œç”¨åŸŸæ··åˆã€`ä½ (è¨€)a@(ä¸”|æˆ–) (ä¸­ç¼€é“¾) {a ä¸­ç¼€é“¾}` å¦‚ `ä½ duangsuseï¼Œåå­—æ˜¯"duangsuse"ä¸”å¹´é¾„æ˜¯18ã€‚`ã€`ä½ duangsuseçš„å¹´é¾„ä¸”å­˜äºå¹´è½»äººä¸”å­˜äºè€å¹´äºº`

æ­¤å¤–ï¼Œ`å¯¹ç”¨æˆ·é‡Œçš„ä½ â€¦â€¦` ä¹Ÿæ˜¯å¯ç”¨çš„ï¼Œã€Œè‹¥(ä½ ä¸”/æˆ–)ã€ã€Œé‡å¤è‹¥(ä½ ä¸”/æˆ–)ã€ï¼Œå½“ç„¶ã€Œå¯¹â€¦é‡Œçš„ä½ â€¦â€¦ã€çš†å¯æ‰§è¡Œã€Œä½œç”¨åŸŸæ··åˆã€ï¼Œ~~ä¸è¿‡ã€Œå¯¹â€¦é‡Œçš„ä½ â€¦â€¦ã€ä¸­å¼•ç”¨å¯ä¸å¸¦ä¸»è¯­ã€Œä½ ã€~~

### å…³äºã€Œä½ ã€ç¬¬äºŒäººç§°æ–‡æ³•çš„ç›¸å…³é¡¾è™‘

>ä¸è¿‡ã€Œå¯¹â€¦é‡Œçš„ä½ â€¦â€¦ã€ä¸­å¼•ç”¨å¯ä¸å¸¦ä¸»è¯­ã€Œä½ ã€

è¿™å®é™…ä¸Šå°±æ˜¯ç»™è¯­è¨€å¼•å…¥äº†ä¸€ä¸ªä¸ä¸€è‡´çš„ç‰¹æ€§ï¼Œä¹‹å‰æ”¯æŒã€Œè‹¥ä½ ã€æ˜¯ä¸ºäº†ä¸€è‡´ã€ç°åœ¨ä¸æƒ³æ”¯æŒä¹Ÿæ˜¯ä¸ºäº†ä¸€è‡´ã€‚
ä¸ºäº†æ›´ç±»ä¼¼äºè‡ªç„¶è¯­è¨€ä¸Šåº”è¯¥æ˜¯å¿…é¡»æ”¯æŒçš„ï¼ˆè€Œä¸”å¯¹äºè‡ªç„¶è¯­è¨€è¿™æ ·çš„è¡¨è¾¾æœ‰å‡†ç¡®æ€§ï¼‰ï¼Œè¿™ç§å†™æ³•æˆ‘é¢„è®¡ä¹Ÿä¼šæ¯”è¾ƒå¸¸ç”¨ï¼Œä¹Ÿä¸æ˜¯å¾ˆéº»çƒ¦ã€‚

ä½†å°±è¯­è¨€å®šä¹‰ä¸Šæ¥çœ‹ï¼Œå®ƒæ˜¯ä¸å¤ªå®¹æ˜“ç†è§£çš„ï¼Œä¸æ˜¯å¾ˆæ¸…æ¥šæ˜¯å¦è¯¥åŠ ã€‚`#PL` `#jueju`

å¯¹äº†ï¼Œä¸ºä»€ä¹ˆä¸æŠŠè¿™ä¸ª ä¸è¿‡ `ã€Œå¯¹â€¦é‡Œçš„ä½ â€¦â€¦ã€` ä¸­å¼•ç”¨å¯ä¸å¸¦ä¸»è¯­ã€Œä½ ã€ çš„ç‰¹åŒ–å¤„ç†ç»™å»æ‰å‘¢ï¼Ÿåæ­£å»æ‰ä¹Ÿä¸ä¼šä½¿å¾—ä»£ç æ›´éš¾çœ‹å•Šï¼è¿™æ ·ä¸å°±ä¸€è‡´äº†å—ï¼Ÿã€Œä½ ã€å°±åƒæ˜¯å¯¹è¡¨è¾¾å¼çš„ä¸€ä¸ªæ ‡ç­¾ï¼Œä¸å­˜åœ¨ä½œç”¨åŸŸå¤„ç†ä¸Šä¸€è‡´æ€§çš„é—®é¢˜ã€‚

â€¦â€¦å¯é‚£æ · `å¯¹â€¦é‡Œçš„ä½ ` å’Œ `å¯¹â€¦é‡Œçš„â€¦â€¦` è¿˜æœ‰ä»€ä¹ˆåŒºåˆ«å•Šï¼Ÿï¼Ÿï¼Ÿé‚£å°±åªèƒ½åˆ æ‰è¿™ä¸ªç”¨æ³•äº†â€¦â€¦
å”‰

å…¶å® `å¯¹â€¦é‡Œçš„ä½ â€¦â€¦` ä¹Ÿæ˜¯æœ‰è¯­è¨€ä¸€è‡´æ€§çš„ï¼Œå› ä¸ºã€Œä½ ã€æœ¬èº«å°±ä»£è¡¨ä½œç”¨åŸŸæ··åˆã€‚

å¯æ˜¯æˆ‘ä»¬ä¸èƒ½è®©

```plain
â€œâ€¦â€¦â€
  è‹¥æ­¤äººä¹‹æ›¾æ€äººï¼Œæ€(æ­¤äºº)ã€‚
  è‹¥ä½ æ­¤äººæˆ–ä¹‹æ›¾ä¼¤äººæˆ–ä¹‹æ›¾ç›—çªƒï¼Œæ­¤äººå»æŠµ(â€œæ­¤äººçš„â€ç½ª)ã€‚
```

è¿™ç§ä»£ç é€šè¿‡å•Šï¼Ÿï¼

è¿™ç»å¥è¶Šè®¾è®¡è¶Šåƒè‡ªç„¶è¯­è¨€äº†ï¼Œå¯è¿™â€¦â€¦çœŸçš„æ²¡é—®é¢˜ä¹ˆï¼›æˆ‘æ„Ÿè§‰ç¬¬äºŒäººç§°æ–‡æ³•æ˜¯ä¸ªæ½˜å¤šæ‹‰ç›’å­ï¼Œæ”¯æŒäº†æŒ‡ä¸å®šä¼šæ€ä¹ˆæ ·ã€‚

è¿™ä¹ˆè¯´å§ï¼Œå…¶å®è¿™ä¸ªé€‰æ‹©ä¹Ÿå°±æ˜¯ç»å¥æ˜¯èµ°ã€Œå€¾å‘è‡ªç„¶è¯­è¨€ã€è¿˜æ˜¯ã€Œå€¾å‘æ›´è§„èŒƒçš„ç¼–ç¨‹è¯­è¨€ã€çš„åŒºåˆ«ï¼Œä¹Ÿå°±æ˜¯è®¾è®¡çš„åˆ†å²”è·¯ã€‚

ä¸é”™ï¼Œå…¶å®ç»å¥å®Œå…¨å¯ä»¥ä¸å¤šä½œè€ƒé‡å°±ç«‹åˆ»ä»¥æˆ‘ä¸Šé¢é‚£ä¸ªæŠ˜è¡·æ³•ç«‹åˆ»å‡†å¤‡åŠ å…¥æ­£å¼è®¾è®¡çš„ï¼Œå¯æˆ‘è§‰å¾—è¿˜æ˜¯æœ‰ç‚¹é—®é¢˜éœ€è¦è®²æ˜ç™½ã€‚
è¿™ä¸ªè¯­æ³•ï¼Œå®ƒä¸åƒ `å°è¯•â€¦æˆâ€¦â€¦` é‚£æ ·ï¼Œå®ƒæ˜¯æ— å¯æ›¿ä»£ä¸èƒ½åˆ é™¤çš„ï¼Œç»å¥é‡Œæ²¡æœ‰ä»»ä½•å…¶ä»–æ–¹æ³•å¯ä»¥ç›´æ¥ä»£æ›¿å®ƒä½œä¸ºè¡¨è¾¾å¼çš„ä½ç½®ï¼Œå› ä¸ºå®ƒä¸€æ˜¯åœ¨æ±‰è¯­è¨€é‡Œå±äºå¯¹è¯­è¨€è¡¨è¾¾æœ‰æå…¶ç‰¹æ®Šåœ°ä½çš„æ„è¯è€Œä¸åº”è¯¥åœ¨ä»»ä½•æƒ…å†µä¸‹ä½œä¸ºåå­—çš„èµ·å§‹ä½¿ç”¨ï¼ŒäºŒæ˜¯å®ƒå¯ä»¥ä½¿å¾— `a > 1 && a in xs` è¿™ç§è¡¨è¾¾å¼æ›´å¥½æè¿°ï¼Œç»å¥é‡Œä¹Ÿæœ‰ç±»ä¼¼çš„å¹¶ä¾‹ï¼ˆä¾‹å¦‚ã€Œã€å«æ‹¬å·çš„ä¸­ç¼€ç®€è®°ï¼‰ã€‚

å°±ç»å¥æœªæ¥è€Œè¨€ï¼Œæˆ‘è§‰å¾—æˆ‘çš„çœ‹æ³•å’Œ Matz æ˜¯ä¸€æ ·çš„ï¼Œä¸èƒ½æŠŠè¯­è¨€è®¾è®¡å¾—å¤ªã€ç®€å•ã€æˆ–è¿‡åˆ†æ•°å­¦ã€è¿‡åˆ†å¼ºè°ƒè¯­è¨€ç†è®ºå‡†ç¡®æ€§ï¼Œæˆ‘ä¸å¸Œæœ›ç»å¥æˆä¸ºã€ä¸­æ–‡ç¼–ç¨‹ã€é¢†åŸŸçš„Scalaï¼ˆçš„ç¡®æˆ‘ä¹Ÿæ²¡é‚£ä¸ªæ°´å¹³ï¼‰ï¼Œä½†æ˜¯æˆ‘è§‰å¾—ã€è‡ªç„¶ã€ä¹Ÿæ˜¯æœ‰é™åº¦çš„ï¼Œä¸èƒ½æ²¡æœ‰ç« æ³•ã€‚

ç¬¬äºŒäººç§°æ–‡æ³•å…¶å®æœ¬èº«å°±æ˜¯ä¸€ç§ä¼šæ‰°ä¹±è¯­è¨€è¡¨è¾¾è§„èŒƒæ€§çš„ç‰¹æ€§ï¼Œæ”¯æŒå®ƒå¯ä»¥è®©è¯­è¨€ã€å¯¹ç¨‹åºçš„æè¿°æ›´ç›´ç™½ã€æ›´è‡ªç„¶ï¼Œæœ‰å¾ˆå¤§çš„ç§¯æä½œç”¨ï¼Œå”¯ä¸€çš„é—®é¢˜æ˜¯â€”â€”å®ƒæ˜¯å¯¹ä½œç”¨åŸŸå®šä¹‰çš„æ‰©å……ï¼Œåˆ©ç”¨å®ƒå¯ä»¥å†™å‡ºè«åå…¶å¦™çš„ç¨‹åºï¼Œè€Œç»å¥ä¸å¯èƒ½æ£€æŸ¥è¿™ç§æƒ…å†µï¼Œå› ä¸ºé¦–å…ˆå®ƒä»¬æœ¬è¯¥ç¬¦åˆè¯­æ³•ï¼Œå…¶æ¬¡è¿™ç§æ£€æŸ¥æ˜¯å¹æ¯›æ±‚ç–µçš„è¡Œä¸ºã€‚

ä¸‹é¢æœ‰ç›¸ä¼¼çš„ä¸‰ä¸ªä¾‹å­ã€‚

```plain
å¯¹æ­¤åŠå…¬å®¤é‡Œçš„ä½ ï¼Œ
  è‹¥å¹´é¾„ä¸å¤§30ä¸”å¤´è¡”æ˜¯æ€»ç›‘ï¼Œè¯´(ä½ çš„åå­—)ã€‚
```

è¿™æ˜¯æ­£å¸¸æƒ…å†µï¼Œä¹Ÿå°±æ˜¯æˆ‘è§‰å¾—æœ‰å¿…è¦åŠ å…¥æ­¤è¯­æ³•çš„ç†ç”±ã€‚â€”â€”å†µä¸”è¿™çš„ç¡®æ˜¯å¾ˆå¸¸è§çš„ä¸€ç§æ¨¡å¼ï¼ˆå½“ç„¶ Kotlin ä¹Ÿå¯ä»¥ç”¨ `E.() -> Unit` æ¨¡æ‹Ÿï¼Œå¯ä¸ºäº†ä¸€è‡´æ€§æœ€å¥½è¿˜æ˜¯åŠ ä¸Šï¼Œè€Œä¸”é‚£æ ·å°±æ²¡æœ‰ç¬¬äºŒäººç§°ã€Œä½œç”¨åŸŸæ··åˆã€äº†ï¼‰

ä¸Šé¢çš„ã€åå­—ã€ã€å¹´é¾„ã€ï¼Œå¾ˆè‡ªç„¶å°±èƒ½çŸ¥é“æ˜¯æŒ‡ã€å­˜äºåŠå…¬å®¤çš„æŸäººã€ã€‚ï¼ˆè¿™é‡Œä¸æé‡Œé¢æœ‰å¾ˆå¤šè¡Œä»£ç çš„æƒ…å†µï¼Œç»å¥é‡Œè¿˜èƒ½å†™å¾ˆå¤æ‚å¾ˆå¤šè¡Œçº¯å±ç¼–ç¨‹æ–¹æ³•æœ‰é—®é¢˜ï¼‰

```kotlin
å¯¹é‡Œçš„ä½ (åŠå…¬å®¤) { if (å¹´é¾„<=30 && å¤´è¡”==æ€»ç›‘) println(this.åå­—) /*æ³¨æ„è¿™é‡Œå°±å’Œç¬¬ä¸€äººç§°çš„thisæ··æ·†äº†ï¼Œæ²¡æ³•ç›´æ¥å¼•ç”¨å¤–å±‚çš„this*/ }
```

Kotlin çš„å†™æ³•ç±»ä¼¼ä»¥ä¸Š

```plain
å¯¹æ­¤åŠå…¬å®¤é‡Œçš„ä½ ï¼Œ
  è‹¥ç”²å›çš„åå­—[0..1]æ˜¯åå­—ï¼Œè¯´("å•Šï¼Œ${åå­—}ä½ å’Œ${ç”²å›}æ˜¯ä¸€å®¶çš„å•Šï¼Ÿ")ã€‚ â€œå¼€ä¸ªç©ç¬‘â€
```

è¿™ç§æƒ…å†µï¼Œå°±æ²¡é‚£ä¹ˆå®¹æ˜“æƒ³å‡ºã€åå­—ã€æ˜¯æŒ‡è°çš„åå­—äº†ï¼ˆç”šè‡³ä¼šä¸åå­—ä½œä¸ºä¸€ç±»äº‹ç‰©çš„æƒ…å†µå‘ç”Ÿæ··æ·†ï¼‰ï¼Œæˆ–è€…è¯´ï¼Œå¯¹äºä»¥ä¸Šä»£ç å¯ä»¥è°ƒæ•´ã€Œæ˜¯ã€çš„è¯­åºä¿®æ”¹ï¼Œå¯æˆ‘ä¹‹å‰è¯´è¿‡ï¼Œä¸¥æ ¼çš„å¥½è¯­è¨€ä¸åº”è¯¥å¯ä»¥å†™å‡ºçƒ‚ä»£ç ï¼Œé‚£å¾€å¾€æ˜¯è®¾è®¡æ€è™‘ä¸å¤Ÿæ·±åˆ»å¯¼è‡´çš„ã€‚

```plain
å¯¹é›¶é£ŸåŒºé‡Œçš„ä½ ï¼Œ
  å–è‰²ç¬”å»å–è‰²(å¤–å°)ä»¤ä¸ºï¼Œè¯´("$å®ƒ $å£æ„Ÿ")ã€‚
```

è¿™é‡Œå°±æ›´æ˜æ˜¾äº†ï¼Œæˆ‘ä»¬å¼•å…¥äº†ä¸€ä¸ªå—ï¼Œè°èƒ½ä¸€çœ¼çœ‹å‡ºã€å£æ„Ÿã€æ˜¯æŒ‡ã€å­˜äºé›¶é£ŸåŒºçš„æŸç‰©ã€çš„å£æ„Ÿï¼Ÿï¼Ÿï¼Ÿ

â€¦â€¦æˆ‘è§‰å¾—æš‚æ—¶è¿˜æ˜¯æ”¯æŒå§ã€‚æ¯•ç«Ÿè¿™ä¸ªè¯­æ³•è™½ç„¶è®©ç»å¥ä¸æ˜¯é‚£ä¹ˆã€ä¸¥æ ¼ã€äº†ï¼Œåœ¨ä¸­æ–‡è¡¨è¾¾é‡Œå®ƒä¹Ÿæ˜¯æœ‰ä»·å€¼çš„ï¼Œè€Œä¸Šé¢ä¸¾å‡ºçš„é—®é¢˜ç¨‹åºå…¶å®æœ¬èº«ä»¥ä¸­æ–‡çš„è§†è§’çœ‹éƒ½æ˜¯è¯­ç´ æ®‹ç¼ºã€é€»è¾‘é”™è¯¯çš„ï¼Œæˆ–è®¸èƒ½å¤Ÿä»¥ä¸­æ–‡çš„æ€è·¯çœ‹ç»å¥ç¨‹åºä¼šæœ‰åˆ©äºä»£ç è´¨é‡çš„æå‡ã€‚

----
æˆ‘è§‰å¾—ï¼Œæ—¢ç„¶éƒ½æ— æ³•ç¡®å®šçš„è¯â€¦â€¦ é‚£è¿˜æ˜¯ç”¨ plan C å¥½äº†ï¼Œå»æ‰ å¯¹â€¦â€¦æˆ‘ çš„ç‰¹æ®Šå¯¹å¾…ï¼Œè¿™æ ·è™½ç„¶çœ‹èµ·æ¥æœ‰ç‚¹å¼±æ™ºä½†ä¸è‡³äºå¼„ä¹±æ•´é—¨è¯­è¨€ã€‚
å¯¹åº”åœ°ï¼Œã€Œä½ ã€çš„ã€æ–‡è¨€å¼ä½œç”¨åŸŸæ··åˆã€ä¹Ÿå°±æ˜¯ã€ä½ (è¨€)â€¦â€¦ã€çš„æƒ…å†µâ€¦â€¦ è¿˜æ˜¯ä¿ç•™å§ã€‚

```plain
å¯¹æ­¤åŠå…¬å®¤é‡Œçš„ä½ ï¼Œ
  è‹¥ä½ çš„å¹´é¾„ä¸å¤§30ä¸”ä½ çš„å¤´è¡”æ˜¯æ€»ç›‘ï¼Œè¯´(ä½ çš„åå­—)ã€‚

äº‹ ä¸¥æ­£æ‰§æ³•(æ­¤äººï¼šäºº) ä¸º â€œç”¨èµ·æ¥ä¸è‡ªç„¶ä½†è¿™åªæ˜¯ä¾‹å­â€
  è‹¥æ­¤äººä¹‹æ›¾æ€äººï¼Œæ€(æ­¤äºº)ã€‚
  è‹¥ä½ æ­¤äººæˆ–ä¹‹æ›¾ä¼¤äººæˆ–ä¹‹æ›¾ç›—çªƒï¼Œä½ å»æŠµ(ä½ çš„ç½ª)ã€‚  
```

è¿™æ ·çœ‹èµ·æ¥ä¸€è‡´æ€§å°±å¥½å¤šäº†ï¼Œã€Œä½ ã€åé¢è·Ÿçš„éƒ½æ˜¯ã€Œä½ çš„ã€ã€Œä½ å»ã€ã€‚

## ä¸­ç¼€æ„è¯(infix keywords)

> ä½œä¸ºä¸­ç¼€çš„æ„è¯éƒ½æ˜¯ __è‹›æ„è¯__

+ å± ä¸å±
+ ä½œ è¯•ä½œ
+ å­˜äº ä¸å­˜äº
+ ä¸” æˆ–
+ å° å¤§ ä¸å¤§ _(<=)_ ä¸å° _(>=)_
+ æ˜¯ ä¸æ˜¯ å³æ˜¯ ä¸å³æ˜¯
+ `+` _ã€åŠ ã€_ `-` _ã€å‡ã€_ `*` _ã€ä¹˜ã€_ `/` _ã€é™¤ã€_ `%` _ã€å–ä½™ã€_ `..` _ã€å–è‡³ã€_

### è¿ç®—ç¬¦ä¼˜å…ˆçº§

`a+(b*c)`ï¼Œ`(*) lessThan (+)` é™åºä¼˜å…ˆç»“åˆ

ä»¥ä¸‹å®šä¹‰åŸºæœ¬æ˜¯ä» [Kotlin Grammar](https://kotlinlang.org/docs/reference/grammar.html#expressions) å¤„èªŠå†™ï¼Œå¯èƒ½æœ‰å°‘è®¸å˜åŠ¨

æ³¨æ„ç»å¥é‡Œçš„è®¿é—®ä¹Ÿæ˜¯ä¸€ç§è¿ç®—ç¬¦ï¼Œä½†ã€Œ`ï¼š`ã€è¯­æ³•ï¼Œï¼ˆåç¼€ï¼‰labelå¹¶ä¸è¢«è®¤ä¸ºæ˜¯å‚ä¸è¡¨è¾¾å¼é“¾çš„ä¸œè¥¿ï¼Œè‹¥æ˜¯åˆ™å®ƒæœ‰æœ€é«˜çš„ä¼˜å…ˆçº§ã€‚

+ è®¿é—®ï¼š`@çš„`ã€`@å»`ã€`@?çš„`ã€`@?å»`
+ åç¼€(postfix)ï¼š`@!`ã€`@[â€¦]` å’Œä»»ä½•ã€Œ~xã€å½¢å¼çš„è®°æ³•
+ å‰ç¼€(prefix)ï¼š`-@` _å–è´Ÿ_ã€`+@` _å–æ­£_ã€`é@` _å–é_
+ ç±»å‹ç®—ç¬¦(type rhs)ï¼š`ä½œ`ã€`è¯•ä½œ`
+ ä¹˜é™¤(multiplicative)ï¼š`*`ã€`/`ã€`%`
+ åŠ å‡(additive)ï¼š`+`ã€`-`
+ åŒºé—´(range)ï¼š`..`
+ è®°æ³•(notation)ï¼šä»»ä½•ã€Œxã€å½¢å¼çš„è®°æ³•
+ ç©ºåˆ™(elvis)ï¼š`ç©ºåˆ™`
+ ç»Ÿä¸€åŒ–åˆ¤æ–­(named checks)ï¼š`å­˜äº`ã€`ä¸å­˜äº`ã€`å±`ã€`ä¸å±`
+ æ¯”è¾ƒ(comparasion)ï¼š`å°`ã€`å¤§`ã€`ä¸å¤§`ã€`ä¸å°`
+ ç›¸ç­‰æ€§(equality)ï¼š`æ˜¯`ã€`ä¸æ˜¯`ã€`å³æ˜¯`ã€`ä¸å³æ˜¯`
+ é€»è¾‘ä¸”(conjuction, both)ï¼š`ä¸”`
+ é€»è¾‘æˆ–(disjuction, either)ï¼š`æˆ–`
+ æ‰©é“ºç®—ç¬¦(spread operator)ï¼š`è®¸å¤š`
+ èµ‹å€¼æè¿°(assignment)ï¼š`=`

ç»å¥æ”¯æŒå…·åè°ƒç”¨(named call)ï¼Œä½†èµ‹å€¼ä¸æ˜¯è¡¨è¾¾å¼

ç»å¥å› ä¸ºæœ‰ã€å–ç½®ã€æŠ½è±¡å’Œã€Œã€ä¸­ç¼€é“¾ä¸éœ€è¦ `+=`ã€`-=` è¿™ç§ç®€è®°èµ‹å€¼ï¼ˆ`xä»¤ç½®ä¸ºã€Œ+aã€`ã€`iä»¤ç½®ä¸ºã€Œå®ƒåã€` å³å¯ï¼‰

ä½†ä¾ç„¶æœ‰ `inc`(`åç»§`)ã€`dec`(`å‰é©±`) ç®—ç¬¦ï¼Œå³ä¾¿å®ƒæ²¡æœ‰ç‰¹å®šçš„è¿ç®—ç¬¦è¯­æ³•æ”¯æŒ

ç±»ä¼¼ Kotlin çš„ get/set/invokeï¼Œç»å¥çš„ _å–å€¼_ã€_ç½®å€¼_ å®ç°äº† `a[i]`ã€`a[i] = x` çš„è¯­ä¹‰ï¼Œç»å¥çš„ _ç”¨_ å®ç°äº† `f()`

## ä¿®é¥°ç¬¦(modifiers)

> ä¿®é¥°ç¬¦ä»¥ `ç”²ã€ä¹™çš„(æ„)` å½¢å¼åº”ç”¨åˆ°æ–‡æ³•ç»“æ„ï¼Œ
> ä½œä¸ºä¿®é¥°ç¬¦çš„æ„è¯éƒ½æ˜¯ __å¸¸æ„è¯__ï¼›`ã€ã€‘`æ‰©ä½çš„è®°ç‰©å®ä¾‹æ˜¯ä¸€ç§ _æ™®é€‚_ çš„ä¿®é¥°ç¬¦

### å¯è§æ€§ã€å¯è¦†ç›–æ€§

+ å…¬å¼€  ç§ä¸‹  æ—å†…  å†…éƒ¨
+ å¼€æ”¾  ç»ˆå®š  è¦†å†™

### æŠ½è±¡ã€å¾…ä¾‹ç‰©|äº‹|é‡|å˜å‚

+ æŠ½è±¡  å®ç°
+ å¾…ä¾‹  å®é™…

### å¯¹ å˜é‡|äº‹|å‚æ•° æœ‰åŒºåˆ†

+ å†…è”  è®°æ³• _å‡å¯_
+ æ™šæˆ  _ä»…å˜é‡_
+ ~~infix~~ _ç»å¥ä½¿ç”¨ã€Œè®°æ³•ã€ï¼Œè€Œä¸æ˜¯infix_ ~~external~~ _ç»å¥ä½¿ç”¨å¾…ä¾‹+ã€åŠ¨æ€é“¾æ¥ã€‘_
+ ç®—ç¬¦  å°¾é€’å½’  æ–­ç»­ _suspendï¼Œä»…ã€Œäº‹ã€ã€ã€Œå‡½æ•°å±ã€_
+ è®¸å¤š _vararg_  è·¨åµŒ ä¸åµŒ _ä»…å‚æ•°_

## ç®€ä¿®é¥°ç¬¦(trivial modifiers)

> ç®€ä¿®é¥°ç¬¦ç›´æ¥åº”ç”¨åˆ°ç›®æ ‡æ„ä»¶ï¼Œæ— é¡»åŠ ã€Œçš„ã€

æ³›å‹å‚æ•° ç”Ÿäº§æ¶ˆè´¹ä½ç½®(producer-consumer position) å’Œ å‹å‚å®åŒ–(reified) ä¿®é¥° _åˆ»æ„æ²¡åŒºåˆ†æ˜¯ã€æ³›å‹å‹å˜ã€è¿˜æ˜¯æ ‡å‡†ç±»å‹å‚æ•°_

+ çœŸ å…¥ å‡º

å±å è‹›ï¼Œç”¨äºå®šä¹‰å˜é‡ã€‚__æ¶æ„å™¨å‚æ•°åˆ—è¡¨ä¸­ä¸å¯ä½¿ç”¨ã€Œå˜ã€ä¿®é¥°ï¼Œä»¥å…ä¸å‚æ•°é»˜è®¤å€¼æ··æ·†__

+ å¸¸  å˜

## æ§åˆ¶æµæ„è¯(control flow keywords)

> æ§åˆ¶æµæ„è¯ä¸€èˆ¬æ˜¯ __è‹›æ„è¯__

+ è‹¥  å¦åˆ™ _åˆ¤(è¨€)ã€åˆ¤æ–­å…¼ç”¨_
+ åˆ¤  åˆ¤æ–­ ä¸Šçš† _è½¯_
+ å¯¹  è§£å¯¹ é‡Œçš„ _è½¯_
+ é‡å¤è‹¥
+ é‡å¤  è‹¥ _ã€‚_
+ å°è¯•  æ¥è¿ ç»ˆç„‰
+ å› _return_ æŠ›ä¸‹ _throw_
+ åœä¸‹ _break_  ç•¥è¿‡ _continue_
+ `@?çš„`ã€`@?å»` _ç©ºä¼ å¯¼ã€å¯ç©ºç±»å‹æ ‡è®°_ ç©ºåˆ™ _(?:)_
+ å›äº¤ _yield_
+ å›é‡å†™ _æ”¹ç‰ˆå°¾é€’å½’ç”¨_

æ³¨æ„ç‚¹ï¼š

+ ã€Œè‹¥ã€åœ¨å¸¦æœ‰ã€Œå¦åˆ™ã€çš„æƒ…å†µä¸‹å¯ä½œè¡¨è¾¾å¼ï¼Œä½†è¡¨è¾¾å¼çš„ã€Œè‹¥â€¦â€¦å¦åˆ™â€¦â€¦ã€ä¸å¾—ä½¿ç”¨å¸ƒå±€å¼é€—å·è¡¨ç¤ºæ³•ï¼›ä¾‹ï¼š`è¯´(è‹¥çœŸï¼Œ1ã€‚å¦åˆ™ï¼Œ0ã€‚)`
+ è€Œä¸”ï¼Œé€—å·è¡¨ç¤ºæ³•è‹¥ç”¨å•è¡Œå½¢å¼å¦‚ `è‹¥pï¼Œop0()ã€op1()ã€op2()ã€‚` åˆ™ä¾ç…§å¯¹åº”ç»“æ„å¯èƒ½é»˜è®¤è§†æœ€åä¸€ä¸ªã€Œã€ã€åçš„è¡¨è¾¾å¼ä¸ºç»“æœå€¼ï¼Œ__å¤šè¡Œçš„å¸ƒå±€å½¢å¼å¿…é¡»å†™ã€Œå›ã€__
+ ã€Œåˆ¤æ–­â€¦â€¦ã€å°±æ˜¯ä¸å¸¦ å®¾è¯­(subjective) çš„ `when {}`
+ ã€Œåˆ¤(å±/å­˜)(è¨€)â€¦â€¦ã€æ˜¯Kotlin `is`ã€`in` åˆ¤æ–­çš„æ ‡å‡†åŒ–å½¢å¼
+ ã€Œåˆ¤ã€ã€Œåˆ¤æ–­ã€å’ŒKotlinä¸€æ ·ï¼Œå¯èƒ½æœ‰ã€Œ`å¦åˆ™`ã€ã€åˆ†æ”¯æƒ…å†µå¯ä»¥ç”¨ã€Œ`ã€`ã€åˆå¹¶ï¼Œä½†æ¯æ¡ã€ç›®æ ‡è·¯å¾„ã€ä½¿ç”¨é€—å·é€—å·è¡¨ç¤ºæ³•è¡¨ç¤º
+ å¸¦å®¾è¯­çš„ã€Œåˆ¤(å½¼:è¨€)â€¦â€¦ã€çš„æ¯æ”¯(branch)é»˜è®¤æ˜¯ã€`å…¶å€¼æ˜¯å½¼`ã€çš„å½¢å¼ï¼Œä»¥ã€Œå®ƒã€å§‹å³æ¢ä¸ºä¸­ç¼€é“¾çš„å½¢å¼
+ ä¸Kotlinä¸åŒï¼Œã€Œå›ã€ã€ŒæŠ›ä¸‹ã€ã€Œåœä¸‹ã€ã€Œç•¥è¿‡ã€é€šé€š __ä¸æ˜¯__ è¡¨è¾¾å¼
+ ã€Œç©ºåˆ™ã€çš„è¯­å¥ç®€è®°å½¢å¼ç”¨é€—å·è¡¨ç¤ºæ³•å¼€å¯
+ ã€Œå›ã€ã€Œåœä¸‹ã€ã€Œç•¥è¿‡ã€æ ‡ç­¾ä»¥ç±»ä¼¼ `å›[æŸæ ‡]` çš„å½¢å¼æ·»åŠ ã€ä¸é€—å·è¡¨ç¤ºæ³•ç»“åˆå¼ `pä»¤åšï¼Œ[è¿™é‡Œ]` çš„å½¢å¼å®šä¹‰ï¼ŒåŸºäºæ–¹æ³•è°ƒç”¨/äº‹å®šä¹‰çš„æ–¹æ³•åéšå¼æ ‡ç­¾ä¹Ÿæ˜¯å­˜åœ¨çš„

> ç»å¥æ¯” Kotlin __æ›´ä¸__ å€¾å‘äºè¡¨è¾¾å¼é£æ ¼ï¼Œå› ä¸ºè®°æ³•å’Œå‡½æ•°ã€ã€å–ç½®ã€æŠ½è±¡å·²ç»è¶³å¤Ÿ

## å¸¸å(predeclared)

+ å®ƒ _ç¬¬ä¸‰äººç§°æ–‡æ³•_
+ æˆ‘ äº²
+ çœŸ å‡
+ ç©º

å¸¦ä½œç”¨åŸŸæ ‡è®°çš„å¸¸åã€Œæˆ‘ã€ã€Œäº²ã€å¯å¸¦ `[]` æŒ‡æ˜å…·ä½“å¼•ç”¨ç›®æ ‡ï¼Œã€Œå®ƒã€ä¸å¯å¸¦

åœ¨ã€Œæ‰©ç‰©ã€å’Œã€Œæ–¹æ³•å±ã€(Kotlin çš„ `T.() -> *`) ä»¥åŠã€Œå†…ç‰©ã€ã€Œå€¼ä¾‹ã€(Kotlin çš„ anonymous `object`) ä¸Šï¼Œã€Œæˆ‘ã€å¯èƒ½æœ‰å¤šç§å¼•ç”¨ç›®æ ‡ï¼Œé»˜è®¤æ˜¯æœ€å†…å±‚çš„ã€Œæˆ‘ã€

ç±»ä¼¼ Kotlinï¼Œå¯¹å¤šè¶…ç±»æ··å…¥å¼ç»§æ‰¿åå­—å†²çªçš„æƒ…å†µä¹Ÿæœ‰åŠæ³•ï¼Œä½¿ç”¨ `äº²<T>[ä½ç½®]` æˆ– `äº²[ä½ç½®]` æ¥æŒ‡å®šä½¿ç”¨æŸç±»ç‰ˆæœ¬ã€ä¸åŒåŸŸé‡Œçš„ã€Œäº²ã€çš„æˆå‘˜

## å¸¸é‡(literal)

### éƒ¨åˆ†è¯æ³•è§„åˆ™

> è°çŸ¥é“å‘¢ï¼Œåæ­£è¿™ä¸æ˜¯æœ€ç»ˆç‰ˆæ–‡æ¡£

+ Comment æ³¨é‡Š `â€œ(Comment|.)*?â€`
+ Symbol ç¬¦å·
+ "String Char" Unicodeè½¬ä¹‰ `\\u[0-9a-fA-F]{4}`
+ String å¸¸æ–‡
+ Char å¸¸å­— `'(Unicodeè½¬ä¹‰|.)'`
+ Decimal å¸¸æ•°
+ "Data Type" ç‰©ç±»
+ Annotation è®°ç‰©ä¿®é¥°
+ Import ä¹¦å¼•å…¥
  + `åŒ… (å¤å) (çš„ å)? ä¸º`
  + `å¼• (å¤å) (æˆ å)?`
  + `å¼•å…¨ (å¤å) çš„? [é™¤ joinBy(åŒè¡Œç©ºæ ¼(ã€),å)]`
  + `å®šè®°æ³• ã€Œ.+ã€`
  + `å¼•è®°æ³• æ— çš„å¤å [é™¤] ã€Œ.+ã€`
+ Variable å˜é‡
+ Function äº‹å®šä¹‰
+ ControlFlow æ§åˆ¶æµæ„è¯
+ Keyword æ™®é€šæ„è¯
+ NormalText ä»£ç æ–‡æœ¬

## ç»å¥ 0.1 çš„ä¿ç•™å­—

> ä»¥ä¸‹ä¿ç•™å­—éƒ½æ˜¯å¸¸æ„è¯

+ `æ¨¡æ¿`ã€`æ¨¡å—`ã€`æ€§è´¨æ¨å¯¼`

## å¸¸è§ç±»å‹(built-in types)

+ åˆ†é…  å€¼ _Any_
+ ç»„ _Array_
+ é”™è¯¯ _Exception_ å¤±è´¥ _Error_
+ æ•ˆæœ _Unit_ æ–­æ­¢ _Nothing_
+ æ–‡ _String_ å­— _Char_
+ çœŸå‡

å’Œ Kotlin ç±»ä¼¼ä½†æ›´ä¸¥æ ¼ï¼Œç»å¥çš„ã€æ–­æ­¢ã€è¢«ä»»ä½•å–å€¼å¤„ä½¿ç”¨æ—¶éƒ½éœ€è¦æ˜¾å¼å†™å‡ºå…¶ç±»å‹(ç”šè‡³äºéã€Œé‡ã€ã€Œäº‹å›ã€å¤„ä¹Ÿè¦æ˜¾å¼æ³¨æ˜ã€Œä½œã€)ã€‚0.1ç‰ˆå¯èƒ½ä¸èƒ½åŒ…æ‹¬ç±»å‹ç³»ç»Ÿç›¸å…³ç‰¹æ€§ã€‚

```plain
å¯¹ä½•<å€¼è€…>å…¶ä¸­ å€¼è€…ï¼šå€¼ çš†æœ‰
æ‰©ç‰© å–ç½®<å€¼è€…?> ä¸º
  äº‹ ç½®ç©º() ä¸º
    æˆ‘å»ç½®ä¸º(ç©º)
  äº‹ è¯´å€¼() ä¸º
    è¯´(å–å€¼())

forall T where T: Any theres
extension Modifible<T?> where
  fun makeNull() where
    this.set(null)
  fun printValue() where
    print(get())
```

æ³›æ•°(æ³›åŒ–æ•°å€¼)

+ å­—èŠ‚  çŸ­æ•°
+ æ•°  é•¿æ•°
+ çŸ­å®æ•°  å®æ•°

## ç¤ºä¾‹

```plain
ç§ä¸‹çš„äº‹ è¯´ä½œè€…(åï¼šæ–‡) = è¯´("ä½œè€…ï¼š$å")

äº‹ ã€è¯µã€Šæ±Ÿå—ã€‹ã€() ä¸º
  è¯´ä½œè€…("æ±‰ æ— åæ°")
  è¯´("æ±Ÿå—å¯é‡‡è²ï¼Œè²å¶ä½•ç”°ç”°ï¼Œé±¼æˆè²å¶é—´ã€‚")
  é‡ ä½ç½® = è¡Œä¸€<æ–‡>("ä¸œ"ã€"è¥¿"ã€"å—"ã€"åŒ—")
  å¯¹ä½ç½®é‡Œçš„æ–¹ä½ï¼Œè¯´("é±¼æˆè²å¶${æ–¹ä½}")ã€‚

ä¾‹ äº‘ä¸€è¯—ï¼šåº”ç”¨ç¨‹åº ä¸º
  å®ç°çš„äº‹ å…¥å£() ä¸º
    è¯´("è¯—äº‘ã€Šæ±Ÿå—ã€‹ä¸º")ï¼›ã€è¯µã€Šæ±Ÿå—ã€‹ã€()

â€œè¯—äº‘ã€Šæ±Ÿå—ã€‹ä¸º
ä½œè€…ï¼šæ±‰ æ— åæ°
æ±Ÿå—å¯é‡‡è²ï¼Œè²å¶ä½•ç”°ç”°ï¼Œé±¼æˆè²å¶é—´ã€‚
é±¼æˆè²å¶ä¸œ
é±¼æˆè²å¶è¥¿
é±¼æˆè²å¶å—
é±¼æˆè²å¶åŒ—â€
```

```plain
å¼•è®°æ³• ç»å¥.é¢è” ã€Œä»¤ä¸ºã€

äº‹ éšä¹˜(ç”²ï¼šæ•°)ï¼šæ•° ä¸º
  è‹¥ç”²æ˜¯ä¸€ï¼Œå›ä¸€ã€‚
  å¦åˆ™ï¼Œ
    é‡ ä¹™ = ç”²-1
    é‡ ä¸™ = é˜¶ä¹˜(ä¹™)
    é‡ ä¸ = ç”²å»ä¹˜(ä¸™)ï¼›å›ä¸
äº‹ å…¥å£() ä¸º
  é˜¶ä¹˜(5)ä»¤ä¸º(::è¯´)
```

```plain
æ–­ç»­çš„äº‹ åç»§èŠ‚ç‚¹(eï¼šèŠ‚ç‚¹) ä¸º
  å˜èŠ‚ç‚¹ a åˆe
  é‡å¤ï¼Œå›äº¤(a)ã€a = açš„ä¸‹ä¸€é¡¹ã€‚å½“aä¸ç©ºã€‚ â€œä¸ç©ºæ˜¯ä¸€ç§åç¼€è®°æ³•â€
å¯¹ä½•<é¡¹>çš†æœ‰ æ‰©ç‰© å¯è¿­<é¡¹> ä¸º
  æ–­ç»­çš„äº‹ å–å‰(å–ï¼šå‘½é¢˜<é¡¹>) ä¸º
    å¯¹æˆ‘é‡Œçš„ï¼Œ
      è‹¥å–(å®ƒ)ï¼Œå›äº¤(å®ƒ)ã€‚å¦åˆ™ï¼Œåœä¸‹ã€‚

äº‹ å¯ç”¨ä»£ç è¿‡æ»¤(idï¼šå…ƒç´ å) ä¸º
  é‡ åŸºdiv = æ–‡æ¡£å»å–ä»¥(id)åçš„å…ƒç´ 
  é‡ ç div = æ–‡æ¡£å»å–ä»¥("$id-code")åçš„å…ƒç´ 
  â€œå½“ç„¶ä¹Ÿæ˜¯è®°æ³•ï¼Œå†…è”ç‰©+è®°æ³•+æ‰©ç‰©â€
  ç divçš„HTMLä»£ç  = "<button>æ˜¾ç¤º ${id} çš„ä»£ç </button>"
  â€œå½“ç„¶ç»å¥å¯ä»¥æœ‰æ›´ç®€æ´è€Œä¸”æ£€æŸ¥æ›´å¤šçš„DSLâ€
  ç divçš„å­ç´ [0]çš„ç‚¹å‡»ç›‘å¬ = å‡½æ•°ï¼Œç divçš„HTMLä»£ç  = æ»¤å‡ºä»£ç (åŸºdiv)æ˜ ä¸º(::HTMLä»£ç )ä»¥("<br>")æ‹¼åˆã€‚

äº‹ æ»¤å‡ºä»£ç (eï¼šå…ƒç´ ) ä¸º
  é‡ å…¨åç»§ = åç»§èŠ‚ç‚¹(e)
  é‡ æ­¤éƒ¨åˆ† = å…¨åç»§å»å–å‰(::éƒ¨åˆ†æœªå®Œ)â€œçš„â€
  é‡ å—ç”¨é¡¹ç›® = æ­¤éƒ¨åˆ†å»æ»¤å‡ºï¼Œæ¥å—ç±»åˆ—è¡¨(å®ƒçš„ç±»åˆ—è¡¨)ã€‚â€œçš„â€
  å›å—ç”¨é¡¹ç›®
å…¶ä¸­ï¼Œ
  äº‹ éƒ¨åˆ†æœªå®Œ(eï¼šå…ƒç´ ) = eçš„ç±»åˆ—è¡¨?å»è¯•å­˜("literate-end") ç©ºåˆ™å¦
  äº‹ æ¥å—ç±»åˆ—è¡¨(classesï¼šå…ƒç´ ) = "language-kotlin"å­˜äºclasses
```

```plain
â€œæ€äººè€…æ­»ï¼Œä¼¤äººåŠç›—æŠµç½ªã€‚â€
å¼•è®°æ³• ç»å¥.ç¬¦å· ã€Œä¹‹ã€

äº‹ ä¸¥æ˜æ‰§æ³•(æ­¤äººï¼šäºº) ä¸º
  è‹¥æ­¤äººä¹‹æ›¾æ€äººï¼Œæ€(æ­¤äºº)ã€‚
  è‹¥ä½ æ­¤äººæˆ–ä¹‹æ›¾ä¼¤äººæˆ–ä¹‹æ›¾ç›—çªƒï¼Œä½ å»æŠµ(ä½ çš„ç½ª)ã€‚
```

### ä¸€äº›è¾…åŠ©çš„è®¾è®¡è‰ç¨¿

+ çœŸå‡(boolean)ã€æ•°å€¼(Number)ã€
+ å­—ç¬¦(byte)ã€çŸ­æ•°(short)ã€æ•°ã€é•¿æ•°(long)ã€
+ çŸ­æµ®æ•°(float)ã€æµ®æ•°(double)ã€
+ å­—(char)ã€æ–‡(String)ã€
+ ç»„(array)ã€å€¼(Object)ã€
+ å‡½æ•°(Function)ã€
+ å¯æŠ›(Throwable)

Bool Num Char Str Ary Object Function Error

å°è£…ã€æŠ½è±¡ã€ç»§æ‰¿ã€å¤šæ€(å­ç±»å‹å¤šæ€ã€å‚æ•°åŒ–å¤šæ€ã€ç‰¹æ®Šå¤šæ€(å‡½æ•°é‡è½½ã€ç±»å‹è½¬æ¢å¤šæ€))

## å½¢å¼åŒ–æ–‡æ³•

ä»‹äºä¸ºå®šä¹‰æ–‡æ³•ï¼Œå¼•å…¥æŸç§æ³›å‘çš„ å½¢å¼åŒ–è¯­è¨€(Formal Language) å’Œ _ä¸€å †çŸ¥è¯†ç‚¹_ ä¼šè®©äººéš¾ä»¥ç†è§£ï¼Œä¸‹é¢çº¦å®šä¸€ç§ç›¸å¯¹ç®€å•çš„å½¢å¼åŒ–æ–‡æ³•æè¿°æ–¹æ³•ï¼š

> ä»¥ä¸‹å†…å®¹æ¶‰åŠ `(1+2)+3` ä¸­ç¼€é“¾(infix chain) å’Œè¡¨è¾¾å¼ç»„ç»‡çš„ç›¸å…³çŸ¥è¯†

+ `a b c` è¡¨ç¤ºé¡ºåº(sequential)
+ `a|b|c` è¡¨ç¤ºåˆ†æ”¯(branch, or)
+ `{a}` è¡¨ç¤ºé‡å¤(repeat)ï¼Œæ³¨æ„`a`__å¿…é¡»å‡ºç°è‡³å°‘ä¸€æ¬¡__
+ `a~t` è¡¨ç¤º`a`é‡å¤ç›´åˆ°`t`å‡ºç°(until)
+ `a!t` è¡¨ç¤º`a`ï¼Œä½†é¢„å…ˆåˆ¤æ–­`t`__æ²¡å‡ºç°æ—¶æ‰ç®—__(unless)
+ `a?` è¡¨ç¤º`a`å¯å‡ºç°ä¹Ÿå¯ä¸å‡ºç°(optional)

> æ€»å…±æœ‰å…­ç±»é¡¹ç›®ï¼Œå®ƒä»¬åå­—çš„é¦–å­—æ¯ç®€å†™ä¸ºï¼š"s b r u u o"ï¼Œå…¶ä¸­ "u u" = "until(~) unless(!)"

æ­¤å¤–è¿˜æœ‰ç»“åˆæ€§è§„åˆ™ï¼Œé»˜è®¤å·¦ç»“åˆã€å¤§è€…å…ˆç»“åˆï¼šoptional/repeat>unless>or>until>sequentialï¼›ä»¥åŠæ‹¬å· `(a)` å®é™…ç”¨äºæ‰‹åŠ¨ ç»„ç»‡(group) è¡¨è¾¾å¼

è§„åˆ™é¢ å€’äº† or å’Œ until çš„é¡ºåºï¼Œå¦‚ `a|b ~t` ä¾¿å®é™…æŒ‡ä»£ `(a|b) ~t` è€Œé `a| (b~t)`

å·¦ç»“åˆæŒ‡äº `(a+b)` çš„ä¸­ç¼€é“¾ `1+2+3` å®é™…è¡¨ç¤º `(1+2)+3`ã€å³ç»“åˆ `1+(2+3)`ï¼Œæ³¨æ„ï¼šè®¡ç®—æœºåœ¨è®¡ç®—ä¸­ç¼€æ—¶é€šå¸¸åªèƒ½æŒ‰ä¸¤ä¸ªä¸€ç»„ã€é¡ºåºè®¡ç®—

å¦‚ Kotlin çš„ `(T) -> (T1) -> R` ä¸ºå³ç»“åˆå®åˆ™è¡¨ç¤º `(T) -> ((T1) -> R)`ã€`category.item.child` ä¸ºå·¦ç»“åˆå®åˆ™è¡¨ç¤º `(category.item).child`

ä¼˜å…ˆçº§ï¼Œä¼˜å…ˆçº§å’Œç»“åˆæ€§ç”¨äºè¡¨ç¤ºã€ç»“åˆåºã€ï¼Œå¶å°”ä¹Ÿå¯ç”¨ã€å·¦/å³ã€ä¼˜å…ˆçº§åŒºåˆ†å¹¶ä¸ºè¡¨ç¤ºã€ç»“åˆåºã€ï¼ŒLua ç¨‹åºè®¾è®¡è¯­è¨€å®˜æ–¹å®ç°å³æŒ‰æ­¤æ³•è¿›è¡Œ

å…¶ä¸­ï¼Œ`a`ã€`b`ã€`c` ä½œä¸ºã€Œé¡¹ã€çš„ä¸€èˆ¬åå­—ã€`t` å¯ä»¥ç†è§£ä¸º _terminate_ (ç»ˆæ­¢) çš„ç¼©å†™ï¼Œä½†å’Œæ˜¯å¦ä¸ºã€Terminator(ç»ˆç»“ç¬¦)ã€æ— å…³

### æ–‡æ³•å®ä¾‹

ä»¥ä¸Šæ˜¯å¯¹åŸºäºæ‰€è°“ã€é¡¹ã€çš„ __åºåˆ—__ çš„ æ¨¡å¼(pattern) çš„ä¸€ç§é«˜é˜¶æŠ½è±¡ï¼Œéœ€è¦å®é™…å®šä¹‰ `a` ç­‰å…·ä½“è¡¨ç¤ºä»€ä¹ˆæ‰èƒ½å·¥ä½œï¼Œè¿™é‡Œï¼š

+ `a`ã€`'a'` ä»£è¡¨ä¸€ä¸ªå­—ç¬¦ï¼Œå½¢å¼äºŒæ”¯æŒã€è½¬ä¹‰(escape)ã€æ¥æè¿°ä¸æ­¤å½¢å¼æœ¬èº«å†²çªçš„å†…å®¹å¦‚ `'\''`ï¼Œè½¬ä¹‰ç±»Kotlinï¼Œå®å®šä¹‰Regex `(\S|'\\?.')`
+ `ABC` ä»£è¡¨ä¸€ä¸ªå­—ç¬¦åºåˆ— `A B C`ï¼Œä½†è‹¥å®ƒå‡ºç°åœ¨`ã€ã€`é‡Œè¿‡åˆ™è¡¨ç¤ºå¯¹å¦ä¸€ä¸ªæ¨¡å¼çš„å¼•ç”¨
+ `[]` è¡¨ç¤ºå­˜äºå…¶ä¸­ _æ‰€æœ‰å­—ç¬¦é¡¹ç›®_ å†…çš„ä»»æ„å­—ç¬¦ï¼Œå¦‚æ¨¡å¼ `[123]` å¯¹è¾“å…¥ `1`ã€`2`ã€`3` å‡å¯è§£æ
+ `[]` é‡Œçš„ `a-z` ä»£è¡¨å­˜äºå­—ç¬¦åŒºé—´ `'a'..'z'` ä¸­çš„å­—ç¬¦ _ï¼ˆå­—ç¬¦é¡¹ç›®ï¼‰_
+ `anychar` è¡¨ç¤ºå•ä¸ªä»»æ„å­—ç¬¦
+ `.` ä»£è¡¨è®¸å¤šç©ºæ ¼

æˆ‘ä»¬å¯ä»¥ç»™æ¨¡å¼å‘½åï¼Œè¿™æ ·ä¹Ÿèƒ½äº§ç”Ÿé€’å½’ï¼ˆå¦‚ä»¥æ‹¬å·æ‹¬ä½ä¸€ä¸ªè¡¨è¾¾å¼çš„ç»“æœï¼Œæœ¬èº«ä¹Ÿæ˜¯ä¸€ç§è¡¨è¾¾å¼ï¼‰

```plain
ã€æ•°ä½ã€[0-9]
ã€ä½ å¥½ä¸–ç•Œã€ä½ å¥½ä¸–ç•Œ
ã€åè¿›åˆ¶ã€æ•°ä½!0 {æ•°ä½}?
```

+ `ä½ å¥½ä¸–ç•Œ("ä½ å¥½ä¸–")` = å¤±è´¥
+ `ä½ å¥½ä¸–ç•Œ("ä½ å¥½ä¸–ç•Œ")` = `'ä½ ' 'å¥½' 'ä¸–' 'ç•Œ'`
+ `åè¿›åˆ¶("0")` = å¤±è´¥
+ `åè¿›åˆ¶("01")` = å¤±è´¥
+ `åè¿›åˆ¶("1")` = `æ•°ä½('1') ç©º`
+ `åè¿›åˆ¶("101")` = `æ•°ä½('1') [æ•°ä½('0'), æ•°ä½('1')]`

æ­¤å¤–ï¼Œç”±äºç»å¥çš„ __ã€Œä¸ºã€æ–‡æ³•ã€ã€é€—å·è¡¨ç¤ºæ³•ã€ã€ã€Œè®°æ³•ã€__ è¦æ±‚è§£æå™¨å¸¦æœ‰ç‰¹å®šä¸Šä¸‹æ–‡ï¼ˆå¦‚å½“å‰é€—å·å—çš„ç¼©è¿›æ·±åº¦ã€å½“å‰æ–‡ä»¶å¼•ç”¨çš„è®°æ³•ï¼‰å·¥ä½œï¼Œè€Œæ— æ³•ç›´æ¥ç”¨ä¸€èˆ¬çš„å½¢å¼åŒ–è¯­è¨€æè¿°ï¼Œä¸‹é¢çš„å®šä¹‰è¦ä¾èµ– `ã€â€¦â€¦ã€`ã€`ã€ä¸ºâ€¦â€¦ã€` æ¥æè¿°åŸºäºã€é€—å·è¡¨ç¤ºæ³•ã€å’Œã€ä¸ºã€çš„è¯­è¨€ç»“æ„ï¼Œä¸ `ã€å•è¨€ã€` ç›¸å¯¹çš„ `ã€è¨€é“¾ã€`ã€`ã€ä¸­ç¼€é“¾ã€` ä¹Ÿæ— æ³•åœ¨æ­¤å®šä¹‰

ä¸€èˆ¬è€Œè¨€ï¼Œåˆ©ç”¨ é€’å½’ä¸‹é™æ³•(recursive descent) åœ¨è¾“å…¥çš„å­—ç¬¦æµä¸Šï¼Œè‡ªé¡¶(èµ·å§‹è§„åˆ™)å‘ä¸‹åœ°è¯»å–è§£æå³å¯ã€‚

----
_ä¸€å †çŸ¥è¯†ç‚¹_ å¦‚ LL(_k_)ã€è¯æ³•åˆ†æ|æ ‡è®°åŒ–|åˆ†è¯(tokenize)ã€è¯æ¡ã€ç»ˆç»“ç¬¦(terminator)å’Œéç»ˆç»“ç¬¦(non terminal)ã€å·¦é€’å½’ã€é¢„è¯»ã€è‡ªåº•å‘ä¸Šã€åŸºäºæ ˆçš„è§£æå™¨ã€ä¸­ç¼€è¿ç®—ç¬¦ä¼˜å…ˆçº§

_è®¸å¤š_ æ˜¯æŒ‡å¤§å°å¯ä¸ºé›¶çš„ï¼›_äº›è®¸_ æ˜¯æŒ‡å¤§å°ä¸å¯ä¸ºé›¶çš„

### è§£æå™¨å®ç° <sub>(Kotlin) Literate</sub>

> æ¦‚æ‹¬ï¼šæ­¤éƒ¨åˆ†æˆ‘ä»¬å°†å®ç°ä¸€ä¸ª JSON è§£æå™¨ã€ä¸€ä¸ªåŠ å‡ä¹˜é™¤è®¡ç®—å™¨ï¼Œä»¥åŠä¸€ä¸ªåŸºäº [Lambda æ¼”ç®—](https://anqurvanillapy.github.io/?p=lies-about-programming-languages-in-mathematical-notations-1)çš„ç®€æ˜“è§£é‡Šå™¨ã€‚

<script>
function *nextSiblings(e) {
  do { yield e; e = e.nextSibling; } while (e != null)
}
function *takeWhile(p, xs) {
  for (let x of xs) {
    if (p(x)) yield x;
    else break;
  }
}
function enableCodeFilter(id) {
  let codeDiv = document.getElementById(`${id}-code`);
  codeDiv.innerHTML = `<button>Show code for ${id}</button>`;
  codeDiv.children[0].onclick = () => { codeDiv.innerHTML = filterCode(id); };
}
function filterCode(id) {
  const notLiterateEnd = it => it.classList==null||!it.classList.contains("literate-end");
  const showByClassList = cl => cl.contains(`language-kotlin`);

  let base = document.getElementById(id);
  let siblings = nextSiblings(base);
  let sliced = takeWhile(notLiterateEnd, siblings);
  let codes = [...sliced].filter(it => it.classList!=null&&showByClassList(it.classList));
  return codes.map(x => x.innerHTML).join(`<br>`);
}
</script>

<div class="literate-begin" id="input-impl"></div>

```kotlin
import java.io.InputStream
import java.io.InputStreamReader

import java.nio.charset.Charset
import java.nio.charset.StandardCharsets.UTF_8
```

ä¸‹é¢æˆ‘ä»¬å°†å…·ä½“å®šä¹‰ä¸€ä¸ªåŸºäº `kotlin.String` å’Œ `java.io.InputStreamReader`ï¼ˆä»¥æ”¯æŒç±»ä¼¼ã€æµè§ˆå™¨æ§åˆ¶å°ã€å¼ _REPL_ï¼‰çš„è§£æå™¨è¾“å…¥å°è£…ï¼Œè§£æå™¨ä½¿ç”¨ã€é€’å½’ä¸‹é™ã€æ–¹å¼å·¥ä½œã€‚

å› ä¸ºå®ç°æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸è®¨è®º `SourceLocation` è¡Œå·çš„å®ç°é—®é¢˜ã€‚

æœªæåŠçš„ä¹ŸåŒ…æ‹¬ [RangeMap](https://github.com/duangsuse-valid-projects/jison/blob/master/src/jvmMain/kotlin/org/parserkt/util/RangeMap.kt) è¿™ç§è¾…åŠ©å·¥å…·ç±»çš„å®ç°ï¼Œå…³äºä¸­ç¼€é“¾æ‰«æã€è‡ªå®šä¹‰ä¸­ç¼€è®°æ³•æ‰«æçš„ã€çº¿ç´¢æ ‘(trie aka. dict tree)ã€å®ç°ä»¥åŠä¸­æ–‡æ•°å­—è¯»å–ç¨åæåŠï¼Œä¼ ç»Ÿï¼ˆç±»ä¼¼Pythonï¼‰çš„å¸ƒå±€æ–‡æ³•å®ç°ä¹Ÿä¼šåœ¨ç¨åé˜è¿°

```kotlin
/** Something with [SourceLocator] tag */
interface SourceLocated { val sourceLocation: SourceLocator }
/** Identifier [file]:[line]:[column] #[position] */
interface SourceLocator { val file: String; val line: Cnt; val column: Cnt
  val position: Cnt }

data class SourceLocation(override val file: String, override var line: Cnt,
  override var column: Cnt, override var position: Cnt): SourceLocator
```

å› ä¸ºæˆ‘ä»¬çš„è§£æå™¨éœ€è¦èƒ½å¤ŸåµŒå¥—åœ°æ ‡è®°(`mark`)/å›æº¯(`reset`)å­—ç¬¦æµï¼Œè€Œä¸”è¦åŒæ—¶æ”¯æŒå¯ä»¥ç´¢å¼•éšæœºè®¿é—®çš„ `Slice` ä»¥åŠã€ä¸€éè¿‡ã€å¼çš„ `Iterator` æµä¸¤ç§è¾“å…¥ (`Slice` å¦‚æ•°ç»„ã€åˆ—è¡¨ã€å­—ç¬¦ä¸²)ï¼Œæ‰€ä»¥å¿…é¡»æœ‰ä¸€ç§æ‰‹æ®µé’ˆå¯¹ `Iterator` å®ç°å¯¹ `mark` æ•°æ®çš„ä¿å­˜ï¼Œæˆ‘ä»¬å°†æŠŠå¯¹åº”çš„ç®—æ³•å’Œæ‰€éœ€çš„å­˜å‚¨ç©ºé—´åˆ†é…å†™åœ¨ `BaseInput` ç±»é‡Œï¼ˆä¹‹æ‰€ä»¥å«æ­¤åï¼Œæ˜¯å› ä¸ºå®ƒä¸å¸¦å¯¹ `SourceLocated` çš„æ”¯æŒä¹Ÿä¸éœ€è¦å¸®åŠ©ä½¿ç”¨å®ƒçš„è§£æå™¨å……å½“ `ErrorHandler`ï¼Œæ¯”è¾ƒç®€å•åŸå§‹ï¼‰

ä¸ºäº†å°½é‡æ³›åŒ–æˆ‘ä»¬çš„åºåˆ—æ¨¡å¼åŒ¹é…åº“ï¼ˆä½¿å®ƒä¸æ­¢å¯ç”¨äºå­—ç¬¦æµï¼Œä¾‹å¦‚å¯è¢«ç”¨äºåœ¨ `Array<out String>` ä¸Šæ‰§è¡Œè§£æï¼‰ï¼Œå°±å…ˆæŠŠ `Reader` æŠ½è±¡ä¸º `Iterator<Char>` äº†ï¼ˆè¿™é‡Œä¸ç”¨ _unboxed_ çš„ `CharIterator`ï¼Œæ­¤æ¡†æ¶æ˜¯æ³›å‹çš„ï¼‰

```kotlin
class ReadIterator(private val reader: InputStreamReader): Iterator<Char> {
  constructor(input: InputStream, charset: Charset = UTF_8): this(InputStreamReader(input, charset))
  override fun hasNext(): Boolean = reader.ready()
  override fun next(): Char = reader.read().toChar()
}
```

ä¸‹é¢ç”±äºæ–‡ç« ç¯‡å¹…åŸå› ï¼Œä¸ä¼šèµ˜è¿°åŸºäº `BufferStack` çš„ `BaseInput` mark/reset å¦‚ä½•å·¥ä½œï¼Œä½œè€…èŠ±äº†è®¸å¤šæ—¶é—´é‡å†™ç±»ä¼¼çš„æ¶æ„ï¼Œè¦æƒ³ä¸€æ­¥ç™»å¤©åœ°ç†è§£ä¸ºä½•è¦è¿™ä¹ˆå†™ï¼Œç€å®ä¸æ•¢å¼ºæ±‚ã€‚

æ­¤å¤–ï¼Œè¿˜å¯ä»¥åˆ©ç”¨ `kotlin.Lazy<T>`ã€`by lazy {}` delegates ç”šè‡³ `List<T?>` å’Œç©ºåˆ¤æ–­æ‰‹åŠ¨å®ç°å¯¹ `BufferStack` æœ¬èº«/å®ƒçš„Buffers çš„æƒ°æ€§æ±‚å€¼ï¼ˆåº”å½“è¿™ä¹ˆåšï¼Œå‡ºäºè§£ææ¡†æ¶æ¶æ„å†…å­˜æ•ˆç‡çš„é—®é¢˜ï¼‰ä½†è¿™é‡Œä¸å¤šè¯´äº†ï¼Œä¸åšå¯¹ç»“æœäº¦æ— å½±å“ã€‚

```kotlin
// å¼•å…¥ä¸€äº›æ•°æ®æŠ½è±¡
typealias Cnt = Int
typealias Idx = Int
interface Sized { val size: Cnt }
inline val Sized.isEmpty get() = size == 0

class Stack<E>(private val storage: MutableList<E>): Sized {
  constructor(): this(mutableListOf())
  override val size: Cnt get() = storage.size
  fun push(item: E) { storage.add(item) }
  fun pop(): E = storage.removeAtEnd()
  val top: E get() = storage[storage.lastIndex]
  fun clear() { storage.clear() }
}
internal fun <T> MutableList<T>.removeAtEnd() = removeAt(lastIndex)
```

é¦–å…ˆï¼Œæˆ‘ä»¬è¦ä¸ºä¸¤ç§è¾“å…¥ï¼ˆåŸºäºä¿å­˜ã€æµæŒ‡é’ˆã€çš„Sliceå¼å’Œä¿å­˜ã€æ•°æ®ç¼“å­˜ã€çš„Iteratorå¼ï¼‰å…¼å®¹ `MarkReset`ï¼Œä¸å¦¨æŠŠä¸¤ç§æ•°æ®æŠ½è±¡å‡ºæ¥ï¼š

```kotlin
interface MarkReset { fun mark() fun reset() fun unmark() }

/** åŸºäºä¿å­˜çŠ¶æ€ [T] æ ˆå½¢å¼çš„å¯å›æº¯ */
abstract class StackMarkReset<T>(): MarkReset {
  private val stack: Stack<T> = Stack()
  protected abstract var saved: T
  override fun mark() { stack.push(saved) }
  override fun reset() { saved = stack.pop() }
  override fun unmark() { stack.pop() }
}
/** åŸºäºä¿å­˜ç¼“å­˜ [layer] æ ˆå½¢å¼çš„å¯å›æº¯ï¼ŒæŠ½è±¡ [newLayer] å’Œ [consumeLayer] */
abstract class BufferStackMarkReset<BUF>(): MarkReset {
  private val bufferStack: Stack<BUF> = Stack()
  protected val layer: BUF? get()
    = if (bufferStack.isEmpty) null else bufferStack.top
  protected abstract fun newLayer(): BUF
  protected abstract fun consumeLayer(layer: BUF)
  override fun mark() { bufferStack.push(newLayer()) }
  override fun reset() { bufferStack.pop().let(::consumeLayer) }
  override fun unmark() { bufferStack.pop() }
}
```

æˆ‘ä»¬å¸Œæœ›å…¼å®¹ `Array<T>`ã€`List<E>`ã€`String` ä½œä¸ºè¾“å…¥ï¼Œå¯å®ƒä»¬çš„ `get`ã€`set`ã€`size`/`length` æ ¹æœ¬ä¸ç»Ÿä¸€ï¼Œè¿™å¯ä»¥é€šè¿‡å®šä¹‰ä¸€ä¸ªç»Ÿä¸€çš„è§„èŒƒå®ç°ï¼š

```kotlin
/** ä¸€ä¸ªç»Ÿä¸€çš„ Array-Like objects æ¥å£å®šä¹‰ */
interface Slice<out T>: Sized {
  operator fun get(index: Idx): T
}
fun <T> slice(ary: Array<T>): Slice<T> = object: Slice<T> {
  override val size: Cnt get() = ary.size
  override fun get(index: Idx) = ary[index]
}
fun <E> slice(list: List<E>): Slice<E> = object: Slice<E> {
  override val size: Cnt get() = list.size
  override fun get(index: Idx) = list[index]
}
fun slice(chars: CharSequence): Slice<Char> = object: Slice<Char> {
  override val size: Cnt get() = chars.length
  override fun get(index: Idx) = chars[index]
}
```

è€ƒè™‘ä¸€ä¸‹è§£æ `1|2|3` çš„è¿‡ç¨‹ï¼Œå¦‚æœè¾“å…¥ `"1"`ï¼Œ`next()` ä¸€éæˆåŠŸè¿˜å¥½è¯´ï¼Œå¯å¦‚æœä¸æˆåŠŸè¯¥æ€ä¹ˆåŠï¼Ÿæ•°æ®æµä¹Ÿå›ä¸å»äº†å•Šï¼Ÿ

è¿™ç§æƒ…å†µåœ¨ç»„åˆè§£æå™¨é‡Œæ˜¯é¢‘ç¹å‘ç”Ÿçš„ï¼Œæ‰€ä»¥è®¸å¤š C-style çš„é€’å½’ä¸‹é™è§£æå™¨éƒ½å¼„äº†ä¸ª `lastChar` è€Œéä¸€ç›´ `getchar()` ç§»åŠ¨æ•°æ®è§†å›¾ï¼Œä½†é‚£æ ·å¤ªéš¾çœ‹â€”â€”é—²å¾—æ²¡äº‹ä¸ºä»€ä¹ˆè¦ä¸€ç›´ç”¨ `lastChar` ç„¶åæˆåŠŸäº†å» `nextChar()`ï¼Ÿ`getchar()` çš„è¯­ä¹‰ä¸æ˜¯æ›´æ˜ç¡®ï¼Ÿ

äºæ˜¯ç°åœ¨ä¸€èˆ¬éƒ½ç”¨ï¼ˆå…¶å®ä¹Ÿå°±æ˜¯æˆ‘ç”¨è¿‡å‡ æ¬¡ï¼‰`peek`/`consume` æ¶ˆè´¹æ¨¡å‹ï¼Œä¸è¿‡å› ä¸º Kotlin æœ‰ `Iterator` æˆ‘ä»¬å°±ç”¨åŸåå§ã€‚

```kotlin
interface Feed<out T>: Iterator<T> { val peek: T }

class StreamEnd: NoSuchElementException("no more")

class IterateFeeder<T>(private val input: Iterator<T>): Feed<T> {
  private var lastItem = input.next() //init
  private var tailConsumed = false //note that "next" represents "consume" now
  override fun hasNext() = input.hasNext() || !tailConsumed
  override val peek: T get() = lastItem
  override fun next(): T
    =  if (input.hasNext()) input.next()
  else if (!tailConsumed) lastItem.also { tailConsumed = true }
  else throw StreamEnd()
}
```

è€ƒè™‘æˆ‘ä»¬å¼€å§‹ã€é¢„å–ã€äº† `input` é‡Œçš„ä¸€é¡¹ï¼Œä¸ºäº†ä½¿å¯ `peek` ç‰ˆæœ¬çš„æ•°æ®å¯¹ `yield(peek); next()` ä¾ç„¶å®Œæ•´ï¼Œæœ€åä¸€æ¬¡ `input` è¿­å®Œåä»ç„¶è¦å¤š `next` ä¸€ä¸ªå°šå­˜äº `lastItem` é‡Œçš„æ•°æ®ã€‚

```kotlin
class SliceFeeder<out T>(private val input: Slice<T>): StackMarkReset<Idx>(), Feed<T> {
  override var saved: Idx = 0
  override fun hasNext() = saved != input.size
  override val peek: T get() = input[saved]
  override fun next() = try { input[saved++] }
    catch (_: IndexOutOfBoundsException) { throw StreamEnd() }
}
```

> ä¸€èˆ¬è€Œè¨€åœ¨å•ä¸ªä½¿ç”¨ `xs[i++]` çš„æ—¶å€™ä¸ä¼šå­˜åœ¨æ„å›¾æ¨¡ç³Šçš„é—®é¢˜ï¼Œä½†åˆ‡ä¸å¯æ»¥ç”¨
<br>~~è¿™é‡Œæ²¡æœ‰æ£€æŸ¥ `next` æ˜¯å¦è¢«è¿‡å¤šè°ƒç”¨ï¼Œå¦‚æœæ‰“ç®—åˆ©ç”¨å¼‚å¸¸ç³»ç»Ÿï¼Œå°±åº”è¯¥ç»Ÿä¸€ä¸¤è€…æŠ›å‡ºçš„å¼‚å¸¸ç±»å‹~~

æ¥ä¸‹æ¥å®šä¹‰æˆ‘ä»¬çš„ `BaseInput` è¦æ¥å—ä¸¤ç§ `Feed` è€Œä¸”è¿˜å¾—å…¼å®¹ `MarkReset`ï¼Œè¯•è¯•åˆ©ç”¨ `as?` æµ‹è¯•ï¼Œå¦‚æœæ¥å—åˆ°çš„ `Feed` å·²ç»å®ç°äº†æ­¤æ¥å£ï¼Œå°±ä¸å¿…å†å¸®å®ƒã€å®ç°ã€ä¸€ä¸ªæ›´æ³›æ³›çš„ç‰ˆæœ¬äº†ã€‚è¿™æ ·ç±»ä¼¼ `java.io.InputStream#markSupported` ä½†åˆ©ç”¨è¯­è¨€å†…éƒ¨ç‰¹æ€§ï¼Œæ¯”ä¹‹æ›´ä¼˜é›…

> å…¶å®ï¼Œå®é™…å·¥ç¨‹å®Œå…¨å¯ä»¥ä»…å¯¹ `T=Char` å®ç° `BaseInput`ï¼Œè¿™æ ·å°±å¯ä»¥åˆ©ç”¨ `StringBuilder` ç±»æ›´é«˜æ•ˆåœ°å·¥ä½œäº†ï¼Œä¸è¿‡è¿™é‡Œä»…ä¸ºç¤ºèŒƒï¼Œä¸ç”»è›‡æ·»è¶³äº†

```kotlin
typealias Buf<T> = MutableList<T>
open class BaseInput<T>(private val feed: Feed<T>): BufferStackMarkReset<Buf<T>>(), Feed<T> {
  private val resetting: Buf<T>?
    = if (feed !is MarkReset) mutableListOf() else null
  override fun hasNext() = feed.hasNext() || hasReset
  override val peek: T get() = feed.peek
  override fun next()
    = (if (hasReset) resetting!!.removeAtEnd()
     else feed.next())
    .also { layer?.add(it) }

  override fun newLayer(): Buf<T> = mutableListOf()
  override fun consumeLayer(layer: Buf<T>)
    { resetting?.addAll(layer.reversed()) }
  override fun mark() = feedMr?.mark() ?: super.mark()
  override fun reset() = feedMr?.reset() ?: super.reset()
  override fun unmark() = feedMr?.mark() ?: super.unmark()

  private val hasReset: Boolean get() = resetting?.isNotEmpty() ?: false
  private val feedMr: MarkReset? = feed as? MarkReset
}
```

è¿™ä¸ªå®ç°åœ¨ `reset()` åˆ°å°šæœ‰ mark å±‚å­˜åœ¨æ—¶ `next()` ä¾ç„¶å·¥ä½œæ­£å¸¸ï¼Œè‡³äºä¸ºä»€ä¹ˆè¦ `reversed()` å’Œ `removeAtEnd()` æ˜¯ä¸ºäº†æ–¹ä¾¿æŠŠ `[1,2,3] [4,5,6]` æ‹¼æ¥å› `6,5,4,3,2,1` è€Œæ— é¡»ä»¤ `MutableList<T>` å» `insertAt(0, _)`ï¼Œå¯èƒ½æ²¡æœ‰ç”¨ä½†æˆ‘è‰¯å¿ƒä¸ä¼šè¿‡ä¸å»â€¦â€¦

<div class="literate-end"></div>

<div class="literate-code" id="input-impl-code">
<script>enableCodeFilter('input-impl')</script>
</div>

----
_REPL_ Read-Eval-Print-Loopï¼Œå¯ä»¥ç†è§£ä¸ºç«‹å³æ‰§è¡Œä»£ç çš„ç¼–ç¨‹äº¤äº’ï¼Œä¸€èˆ¬ç”¨äºè¯•ç”¨æ—¢æˆä»£ç 

_è§£æå™¨_ ä¸€èˆ¬ä¸ºè¾“å…¥æ˜¯æŸç§ã€æ•°æ®æµã€çš„ç¨‹åºï¼Œå®ƒè¯•ç€ä»æµä¸­æå–ç»™å®šç»“æ„ï¼Œå¦‚æŠŠ `1: 2` æå–ä¸º `(pair 1 2)`

_è§£é‡Šå™¨_ å¯¹è¯­è¨€æŠ½è±¡ç»“æ„è¿›è¡Œå®é™…è®¡ç®—çš„ä¸œè¥¿ï¼Œè¿™ä¸ªæŠ½è±¡ç»“æ„ä¸€èˆ¬æ˜¯è¯­æ³•æ ‘å¦‚ `(add 1 (add 1 9))`

_ç¼–è¯‘å™¨_ ä»ã€æºè¯­è¨€ã€åˆ°ã€ç›®æ ‡è¯­è¨€ã€çš„ç¿»è¯‘å™¨ï¼Œæºå’Œç›®æ ‡å¯ä»¥æ˜¯åŒæŠ½è±¡å±‚æ¬¡çš„è¯­è¨€ï¼Œè¯­è¨€ä¸­åŒ…æ‹¬ä½å±‚æ¬¡çš„æœºå™¨è¯­è¨€ã€æ±‡ç¼–å¼è¯­è¨€å’Œé«˜çº§è¯­è¨€

_unboxed_ åœ¨ä¼ ã€Œå€¼ã€æ—¶ï¼ŒJava æä¾› by-reference å’Œ by-value çš„å½¢å¼ï¼Œå¦‚ `int` å’Œ "boxed" `java.lang.Integer`ï¼Œåè€…å¯èƒ½éœ€è¦ _GC_ è‡ªåŠ¨ç®¡ç†ï¼Œè¿™æ˜¯åº•å±‚å­˜å‚¨åˆ†é…ä¸Šçš„é—®é¢˜ï¼Œä½¿ç”¨ä¸Šåˆ†ä¸å‡ºåŒºåˆ«

_GC_ Garbage Collectorï¼Œè‡ªåŠ¨å†…å­˜ç®¡ç†å™¨ï¼Œç°ä»£ç¼–ç¨‹è¯­è¨€ä¸€èˆ¬éœ€è¦ä¸€äº›å¹¶ä¸ã€Œè½»é‡(lightweight)ã€çš„ã€èšåˆé‡(product value)ã€ï¼ˆå¦‚ `String` æ˜¯ä¸€å¤§å †å­—ç¬¦çš„æ’åˆ—ã€`List<E>` æ›´æ˜¯ï¼‰è€Œå®ƒä»¬æ— æ³•ç›´æ¥åœ¨ä¸åŒçš„å‡½æ•°é‡Œä»¥å’Œ `int`ã€`long` è¿™ç§ã€Œæ ‡é‡(scalar)ã€ç›¸åŒ by-copy å¤åˆ¶æ–¹å¼æ–°å»ºå’Œä¼ é€’ï¼Œä¸€èˆ¬çš„æ–¹æ³•æ˜¯ã€æŒ‰å¼•ç”¨ä¼ ã€ï¼Œä¹Ÿå°±æ˜¯å…ˆæŠŠç›®æ ‡èšåˆé‡ã€Œ_åˆ†é…_ã€åœ¨ _å­˜å‚¨å™¨_ æä¾›çš„ç©ºé—´é‡Œï¼Œç„¶åä¼ é€’ç›®æ ‡çš„åœ°å€(address)ï¼Œè¿™ä¹Ÿæ¶‰åŠæ•°æ®å¯¹è±¡å¯å˜æ€§çš„é—®é¢˜ï¼Œå¦‚ C é‡Œä¼ å‡º `int` å¯¹ caller(è°ƒç”¨è€…) è‚¯å®šä¸æ˜¯å¯å˜çš„ï¼ˆä½ å¤åˆ¶äº†å¦å¤–ä¸€ä»½äº¤å‡ºï¼‰ï¼Œä½† C String: `char *` _æŒ‡é’ˆ_ å¯¹ callee(è¢«è°ƒè€…) å°±æ˜¯å¯æ”¹åŠ¨çš„äº†ï¼›GC å…è®¸ä½ æŠŠåº•å±‚çš„å­˜å‚¨è§†ä¸ºå¯¹è±¡ï¼Œåœ¨éœ€è¦çš„æ—¶å€™å¯ä»¥åˆ†é…æ–°å¯¹è±¡ã€åœ¨æŸå¯¹è±¡ä¸èƒ½å†è¢«å¼•ç”¨æ—¶ï¼ˆæ¯”å¦‚ï¼Œä»æœ€åä¸€ä¸ªå¼•ç”¨å®ƒçš„åˆ—è¡¨ä¸­è¢«ç§»é™¤ï¼‰è‡ªåŠ¨å›æ”¶å®ƒå ç”¨çš„å†…å­˜ï¼Œç®€å•çš„ GC ç®—æ³•å¦‚ Rcï¼ˆå¼•ç”¨è®¡æ•°ï¼‰å’Œ MarkSweepï¼ˆæ ‡è®°-æ¸…é™¤ï¼‰ç­‰

_åˆ†é…_ è¿™é‡ŒæŒ‡å¯¹å­˜å‚¨å™¨ç©ºé—´çš„åˆ†é…ï¼Œå¥½æ¯”å°±é¤æ—¶åº§ä½åˆ†é…ä¸€æ ·ï¼Œåœ¨æŸäººåƒå®Œä¹‹å‰ä¸èƒ½ç©ºå‡ºæ¥å¦ä½œä»–ç”¨ï¼Œå…¶ä¸­æŸäººå¯ä»¥ç†è§£ä¸ºè®¡ç®—å°šå­˜ä¾èµ–çš„æœ‰ç”¨æ•°æ®ã€‚

_å­˜å‚¨å™¨_ å¦‚è£¸è®¡ç®—æœºæš´éœ²å‡ºçš„å†…å­˜æˆ–æœºå™¨å¯„å­˜å™¨(register)ï¼Œä¸€èˆ¬å¯ä»¥æŒ‰å­˜å‚¨ç¼–å·ï¼ˆåœ°å€ï¼‰éšæœºè®¿é—®ï¼Œå¯ç”¨äºå­˜æ•°å€¼ç­‰

_æŒ‡é’ˆ_ æŒ‡é’ˆæ˜¯ C ç›¸è¾ƒå¾ˆè€å¾ˆè€çš„éç»“æ„åŒ–ç¼–ç¨‹æ–¹å¼ä¸€ä¸ªå¾ˆæœ‰ç”¨çš„æå‡äº†ï¼Œå®ƒæ˜¯ç¼–è¯‘å™¨å’Œç¼–ç¨‹è¯­è¨€å¯¹åº•å±‚å­˜å‚¨å™¨ã€Œç›¸å¯¹å®‰å…¨ã€çš„å°è£…ï¼Œä½†ä»æœ‰æº¢å‡ºç­‰é—®é¢˜

#### å®ç°ç»„åˆå¤ç”¨éƒ¨åˆ†

<div class="literate-begin" id="comb-impl"></div>

> ä¸‹é¢æˆ‘ä»¬å°†ä¾ç…§ä¸Šæ–‡å¯¹ã€å½¢å¼åŒ–æ–‡æ³•ã€çš„æè¿°ï¼Œå®ç°å…­ä¸ªç»“æ„çš„å‡½æ•°å¼æŠ½è±¡æ¨¡æ¿ï¼Œä»¥ ~~é«˜é˜¶å‡½æ•°~~ __é¢å‘å¯¹è±¡å­ç±»__ çš„å½¢å¼

è¿™å…­ä¸ªæ¨¡æ¿åˆ†åˆ«æ˜¯ __sequential, branch, repeat, until, unless, optional__

å®ƒä»¬ä»£è¡¨ __é¡ºåºã€åˆ†æ”¯ã€é‡å¤ã€é‡å¤ç›´åˆ°ã€å¦å®šå‰æã€å¯é€‰__ çš„æ¨¡å¼

```kotlin
interface Parser<T, out R> {
  fun read(s: BaseInput<T>): R?
}
inline val notParsed: Nothing? get() = null
```

æˆ‘ä»¬ä¹‹å‰ä¹Ÿç”¨è¿‡ `typealias Parser<T, R> = (BaseInput<T>) -> R?` çš„ç‰ˆæœ¬ï¼Œå¯é‚£æ ·å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œå¦‚æ‰©å±•å‡½æ•°è¾ƒä¸ºæ··æ·†ã€‚

ä½†åœ¨è¿™ä¹‹å‰è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¯¹äºè¦è§£æå¤šé¡¹çš„ __sequentail, repeat, until__ï¼Œå®ƒä»¬çš„ç»“æœè¯¥å¦‚ä½•è¡¨è¾¾ï¼Ÿ

ä¸€èˆ¬æ¥è¯´è‚¯å®šç¬¬ä¸€ä¸ªæƒ³åˆ°ç”¨ `List<R>` æ¥è¡¨è¾¾ï¼Œå¯é‚£æ ·çš„è¯ï¼Œå¦‚è§£æ `251` è¿™æ ·çš„æ•°å­—æˆ‘ä»¬å¯ä»¥ `acc*10 + digi` å®ç°ï¼Œä¿å­˜å®ƒä»¬çš„å­—ç¬¦å½¢å¼å°±æ˜¾å¾—å¤šæ­¤ä¸€ä¸¾ã€‚

äºæ˜¯æˆ‘ä»¬å¼•å…¥ä¸€ä¸ª `Reducer<T, R>` æ¥è¡¨ç¤ºå¯¹è¿™ç±»è§£æå™¨ç»“æœçš„è®¡ç®—æ–¹å¼ï¼š

```kotlin
interface Reducer<in T, out R> {
  fun accept(item: T)
  fun finish(): R
}
```

ä»‹äºæˆ‘ä»¬å¼€å§‹çš„è®¾è®¡ç›®çš„å°±æ˜¯æŠ½æ `List<R>` çš„ã€è§£æè¿”å€¼æ“ä½œæ¨¡å¼ã€ï¼Œè‚¯å®šèƒ½å¤Ÿæƒ³åˆ° `Reducer` æ˜¯è¦åŒ…å«æŸç§æ•°æ®çŠ¶æ€çš„ï¼ˆæ¯”å¦‚ `List` å®ä¾‹ï¼‰

äºæ˜¯ï¼Œæˆ‘ä»¬è¿˜è®¤ä¸ºæœ‰ __åˆ†é…__ å¸¦çŠ¶æ€å­˜å‚¨çš„ `Reducer` çš„æ–¹å¼çš„æŠ½è±¡ï¼Œèµ·åä¸º `Reduce`

```kotlin
typealias Producer<R> = () -> R
typealias Reduce<T, R> = Producer<Reducer<T, R>>
```

æ­¤å¤–ï¼Œä¸ºäº†æ ‡å‡†åŒ–ç”¨æ³•ä»¥åŠä½¿ç”¨æ–¹ä¾¿ï¼Œæˆ‘ä»¬æ·»åŠ ä¸¤ä¸ªå­ç±»ï¼š

```kotlin
/** Build [R] with temporatory [A], [self], [onAccept], [finish] */
abstract class EffectReducer<T, A, R>: Reducer<T, R> {
  final override fun accept(item: T) { self.onAccept(item) }
  abstract val self: A
  abstract val onAccept: A.(T) -> Any?
}
open class MonoidReducer<T>(mzero: T, private val mplus: Join<T>): Reducer<T, T> {
  private var accumulator = mzero
  override fun accept(item: T) { accumulator = accumulator.mplus(item) }
  override fun finish() = accumulator
}

typealias Join<T> = T.(T) -> T
private fun <E> MutableList<E>.add1(item: E) { add(item) } // å¾…ä¼šä½¿ç”¨
```

åœ¨ä½¿ç”¨æ—¶ï¼Œä¾¿å¯ç±»ä¼¼è¿™æ ·å®šä¹‰ï¼š

```kotlin
class AsList<T>: EffectReducer<T, MutableList<T>, List<T>>() {
  override val self: MutableList<T> = mutableListOf()
  override val onAccept = MutableList<T>::add1
  override fun finish() = self as List<T>
}

object DecShift: MonoidReducer<Int>(0, { this*10 + it })

//val _nil: Reduce<Int, List<Int>> = ::AsList
```

å› ä¸ºæˆ‘ä»¬æŠ½æå‡ºäº† seq, repeat, until è§£æå™¨çš„è¿”å›ç±»å‹ï¼ŒåŸ `T`ã€`R` ä¸¤ä¸ªç¬¦å·å°±ä¸å¤Ÿç”¨äº†ï¼ˆå¤§è§£æå™¨æœ¬èº«çš„è¿”å›ç±»å‹éœ€è¦èµ·æ–°åå­—ï¼‰

æˆ‘ä»¬æŠŠå­è§£æå™¨è¾“å…¥å« `IN`ï¼Œè€Œ `T`ã€`R` åˆ™ä»£è¡¨å­è§£æå™¨è¾“å‡ºå’Œè¿”å›ç±»å‹

+ 's' é¡ºåºè§£æå™¨ `a b c`ï¼š

```kotlin
class Seq<IN, T, R>(private val reduce: Reduce<T, R>,
    private vararg val sub: Parser<IN, T>): Parser<IN, R> {
  override fun read(s: BaseInput<IN>): R? {
    val reducer = reduce()
    for (item in sub) {
      item.read(s)?.let(reducer::accept)
        ?: return notParsed
    }
    return reducer.finish()
  }
}
```

+ 'b' åˆ†æ”¯è§£æå™¨ `a|b|c`ï¼š

è¿™é‡Œï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿä½¿ç”¨ä¹‹å‰å¯¹äº `MarkReset` çš„å®šä¹‰äº†

```kotlin
class Or<IN, T: Any>(private vararg val sub: Parser<IN, T>): Parser<IN, T> {
  override fun read(s: BaseInput<IN>): T? {
    for (item in sub) {
      s.mark();
      val parse = item.read(s)
      if (parse == notParsed)
           { s.reset() }
      else { s.unmark(); return parse }
    }
    return notParsed
  }
}
```

+ 'r' é‡å¤è§£æå™¨ `{a}`ï¼š

```kotlin
class Repeat<IN, T: Any, R>(private val reduce: Reduce<T, R>,
    private val item: Parser<IN, T>): Parser<IN, R> {
  override fun read(s: BaseInput<IN>): R? {
    val reducer = reduce()
    var parse: T? = item.read(s) ?: return notParsed
    do { reducer.accept(parse!!); parse = item.read(s) }
      while (parse != notParsed)
    return reducer.finish()
  }
}
```

<div class="literate-end"></div>

<div class="literate-code" id="comb-impl-code">
<script>enableCodeFilter('comb-impl')</script>
</div>

#### å…³äºä¸­ç¼€é“¾çš„è§£æ

ä¸­ç¼€é“¾è§£ææœ¬è´¨ä¸Šæœ‰ç‚¹ç±»ä¼¼å¯¹åˆ—è¡¨æ’åºçš„è¿‡ç¨‹ï¼Œä¸è¿‡è¾“å…¥æ˜¯ä¸å¯éšæœºè®¿é—®çš„è¯æ¡æµï¼Œèƒ½åšçš„hackç›¸å¯¹æ›´å°‘ä¸€äº›

ç±»ä¼¼æ’åºé—®é¢˜ï¼Œæœ‰è®¸å¤šäººè®¾è®¡è¿‡è®¸å¤šç§æ–¹æ³•ï¼Œåˆ©ç”¨æ ˆã€åŒæ ˆã€å¤šå±‚å‡½æ•°è°ƒç”¨/ç­‰å¾…åµŒå¥—ï¼Œæ¥è§£å†³è¿™ä¸ªã€å¦‚ä½•ä» `1+2*3+0` åˆ° `1+(2*3)+0`ã€çš„é—®é¢˜ï¼Œä½†å¯¹åˆå­¦è€…æ¥è¯´ _å¤ªå¤æ‚_ï¼Œè¿™é‡Œä¸èµ˜è¿°ã€‚

`a â¦ b â¦ (c)` (`c` has no next operator, terminates this chain)

`â†‘____â†‘` æ¯”è¾ƒè¿™ä¸¤ä¸ªç®—ç¬¦çš„ä¼˜å…ˆçº§ï¼Œçœ‹æ˜¯ `(a â¦ b) â¦ c` è¿˜æ˜¯ `a â¦ (b â¦ c)`ï¼›åè€…æ„å‘³æœ¬å±‚é€’å½’è¦ç­‰å¾… `bâ¦c` çš„ç»“æœå¹¶åœ¨å®Œæˆæ—¶åœ¨å‰é¢åŠ  `aâ¦`

> ç»™ä½  `scanAtom()`ã€`scanInfix()`ï¼Œè¯·å®Œæˆæ‰«æä¸­ç¼€é“¾çš„ç®—æ³•

æŒ‰ç…§ä¸€èˆ¬çš„æ–¹æ³•ï¼Œå°±æ˜¯æ¯”è¾ƒæŸç®—ç¬¦ä¸ã€å®ƒåé¢è¡¨è¾¾å¼çš„ç®—ç¬¦ï¼ˆå¦‚æœæ²¡æœ‰å°±è¡¨ç¤ºè§£æå®Œäº†ï¼‰ã€‘ã€è‹¥æŸç®—ç¬¦èƒœåˆ™ã€ç»“åˆã€äº† `aâ¦b`ï¼Œç„¶åé€’å½’ä¸‹å»æ‰«æä½™é¡¹

ä¸ºäº†å®ç° `(aâ¦b)` å…ˆç»“åˆåè¿˜èƒ½è¢« `â¦c` ä½¿ç”¨ï¼Œä»¥åŠç¬¬äºŒä¸ªæœ¬æ¥æ˜¯ã€é¢„å–ã€çš„ `â¦` ç®—ç¬¦çš„ä¼˜å…ˆçº§ä¿¡æ¯èƒ½ä½œä¸ºä¸‹ä¸€æ¬¡ä¼˜å…ˆçº§æ¯”è¾ƒçš„ã€Œå·¦è¾¹ã€ä¹Ÿå³ _"a"_ å‚ä¸ä¸‹ä¸€ä¸ª _"a<b"_ çš„æ¯”è¾ƒï¼Œæˆ‘ä»¬è®¤ä¸ºå‚æ•°å¿…é¡»åŒ…å«ä¸¤é¡¹ï¼š

```kotlin
fun infixChain(base: Atom, op_left: Op? = null): Atom {
  val op1 = op_left ?: scanInfix() ?: return base  //'+' in 1+(2*3)... | atom "1"
  val rhs1 = scanAtom() //'2'
  val op2 = scanInfix() ?: return op1.join(base, rhs1) //(aâ¦b) "terminated"
  return when { // lessThan b => win; default ("="): left assoc
    op1 <= op2 -> infixChain1(op1.join(base, rhs1), op2) //(a â¦ b) â¦ ...
    op1  > op2 -> op1.join(base, infixChain1(rhs1, op2)) //a â¦ (b â¦ ...)
    else -> impossible()
  }
}
```

å…·ä½“å®ç°çš„åšçš„æ‚äº‹æœ‰ç‚¹å¤šï¼ˆæ¯”å¦‚åŒ…æ‹¬äº†åˆ¤æ–­æ˜¯ä¸­ç¼€é“¾è¿˜æ˜¯å•é¡¹çš„é€»è¾‘ï¼Œä»¥åŠä¸Šé¢ä¹Ÿæåˆ°çš„å¯¹é¢„å–infixçš„ä¿ç•™æ€§ä¼ é€’ï¼‰ï¼Œä½†å®ƒçš„ç®€æ´æ€§ä»ç„¶å¯ä»¥ä»¤äººæ¥å—

----
_å¤ªå¤æ‚_ è®°å¾—æˆ‘ [æœ‰ä¸€æ¬¡](https://github.com/duangsuse-valid-projects/three-kt-files/blob/master/src/commonMain/kotlin/Calc.kt#L103) ç”¨åŸºäº `kotlin.collection.MutableList<E>` çš„æ ˆè€Œä¸æ˜¯ç³»ç»Ÿæ ˆå†™äº†ä¸€æ¬¡ä¼ ç»Ÿæ–¹å¼çš„ä¸­ç¼€ä¼˜å…ˆçº§è§£æå™¨ï¼Œä»£ç è¡Œæ•°è¶³è¶³æ˜¯é€’å½’ä¸‹é™çš„ __3å€__ï¼Œè¿˜é¢å¤–å®šä¹‰äº†ä¸¤ä¸ªæ ˆçš„è¾…åŠ©ç±»ï¼Œè·‘åˆ†ç»“æœè¿˜ä¸ç†æƒ³

#### ç¼–è¯‘å™¨å‚æ•°

å¯¹ç»å¤§éƒ¨åˆ†ç¨‹åºè®¾è®¡è¯­è¨€æ¥è¯´ï¼Œç¬¬ä¸€ä¸ªç‰ˆæœ¬çš„ç¼–è¯‘å™¨ä¼šæ¯”è¾ƒç®€å•ä»¥æ–¹ä¾¿å‘ç°é—®é¢˜ã€å¿«é€Ÿé‡‡å–è¡ŒåŠ¨ï¼Œè€Œä¸”åœ¨ç¬¬ä¸€ç‰ˆå®ç°ä¹‹å‰ï¼Œæ— æ³•ç›´æ¥ä»¥è¿˜æœªå®ç°çš„ç¼–è¯‘å™¨å®ç°ã€_è‡ªä¸¾_ã€ç¼–è¯‘å™¨

`jueju å‚æ•° æºæ–‡ä»¶`

å…¶ä¸­ï¼Œå‚æ•°å¯ä¸º

+ `-language-version` è¯­è¨€ç‰ˆæœ¬
+ `-T ç›®æ ‡è¯­è¨€`ã€`-t ç›®æ ‡å¹³å°å‚æ•°`*
+ `-d è¾“å‡ºç›®å½•`
+ `-run` å®Œæˆç¼–è¯‘ç›´æ¥æ‰§è¡Œ

ä»¥åŠ

+ `-verbose` æ›´è¯¦ç»†çš„å¤„ç†è¿‡ç¨‹è¾“å‡º
+ `-version` æ˜¾ç¤ºç¼–è¯‘å™¨ç‰ˆæœ¬å’Œç›¸å…³ä¿¡æ¯
+ `-Werror` è‹¥ç¼–è¯‘ä¸­æœ‰ä»»ä½•è­¦å‘Šï¼ŒæŠ¥é”™
+ `-nowarn` ä¸æŠ¥å‡ºè­¦å‘Š

----
_è‡ªä¸¾_ è¿™é‡ŒæŒ‡æŸç§ç¼–è¯‘å™¨å®Œæˆå¯¹ã€ä»¥è‡ªå·±çš„æºè¯­è¨€æè¿°çš„ï¼Œè‡ªèº«çš„ä»£ç ã€çš„ç¿»è¯‘ï¼Œå‰ææ¡ä»¶æ˜¯å¾—å…ˆæœ‰ã€ç¬¬ä¸€ä¸ªã€è¿™ä¸ªç¼–è¯‘å™¨å­˜åœ¨
